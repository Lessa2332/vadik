<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR Язик-Слоти</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      color: white;
      font-family: 'Arial', sans-serif;
      touch-action: none;
    }
    #video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    #ui {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    #instruction {
      font-size: 28px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 40px;
      background: rgba(0,0,0,0.6);
      padding: 15px 30px;
      border-radius: 15px;
      pointer-events: auto;
      transition: opacity 0.3s;
    }
    #slots {
      display: none;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
      pointer-events: none;
    }
    .slot {
      width: 130px;
      height: 160px;
      background: white;
      border: 3px solid gold;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transition: transform 0.1s;
      padding: 10px;
    }
    .slot-text {
      color: #000;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      line-height: 1.3;
      word-wrap: break-word;
    }
    #result {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      pointer-events: auto;
      padding: 20px;
      text-align: center;
    }
    #result-text {
      background: white;
      color: #000;
      padding: 30px;
      border-radius: 20px;
      border: 4px solid gold;
      font-size: 28px;
      font-weight: bold;
      line-height: 1.4;
      max-width: 90vw;
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.7);
      margin-bottom: 30px;
    }
    #playAgain {
      margin-top: 20px;
      padding: 14px 40px;
      font-size: 22px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <video id="video" playsinline muted></video>
  <div id="ui">
    <div id="instruction">ПОКАЖИ ЯЗИК!</div>
    <div id="slots">
      <div class="slot"><div class="slot-text" id="s1">Заспівай Вадіку пісню</div></div>
      <div class="slot"><div class="slot-text" id="s2">Розкажи найсмішнішу історію про Вадіка</div></div>
      <div class="slot"><div class="slot-text" id="s3">Назви три найкращі якості іменинника</div></div>
    </div>
  </div>
  <div id="result">
    <h2 style="color: gold; font-size: 36px; margin-bottom: 20px;">ТВІЙ ВИБІР</h2>
    <div id="result-text"></div>
    <button id="playAgain">ГРАТИ ЩЕ</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

  <script>
    const video = document.getElementById("video");
    const instruction = document.getElementById("instruction");
    const slotsContainer = document.getElementById("slots");
    const resultPanel = document.getElementById("result");
    const resultText = document.getElementById("result-text");
    const playAgainBtn = document.getElementById("playAgain");

    // Усі завдання
    const tasks = [
      "Заспівай Вадіку пісню",
      "Розкажи найсмішнішу історію про Вадіка",
      "Назви три найкращі якості іменинника",
      "Станцюй «танець» для Вадіка",
      "Пригадай улюблений напій Вадіка",
      "Зроби з Вадіком круте селфі",
      "Скажи Вадіку комплімент на «В»",
      "Побажай Вадіку мільйон доларів гучно",
      "Пригадай вашу першу зустріч",
      "Обійми Вадіка найміцніше за всіх",
      "Покажи Вадіка через десять років",
      "Придумай Вадіку супергеройське прізвисько",
      "Промов тост лише мовою жестів",
      "Назви улюблену страву іменинника",
      "Розкажи, чому Вадік — крутий",
      "Виконай одне бажання іменинника зараз",
      "Замов привітання через штучний інтелект"
    ];

    let tongueDetected = false;
    let spinning = false;
    let spinInterval = null;

    // Ініціалізуємо FaceMesh
    const faceMesh = new FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults(onFaceMeshResults);

    const camera = new Camera(video, {
      onFrame: async () => { await faceMesh.send({ image: video }); },
      width: 640,
      height: 480,
      facingMode: "user"
    });
    camera.start();

    function onFaceMeshResults(results) {
      if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
        if (tongueDetected) {
          tongueDetected = false;
          startHideSequence();
        }
        return;
      }

      const landmarks = results.multiFaceLandmarks[0];
      const lipTop = landmarks[13].y;
      const lipBottom = landmarks[14].y;
      const tongueTip = landmarks[20].y;

      const mouthOpen = lipBottom - lipTop > 0.03;
      const tongueVisible = mouthOpen && tongueTip < lipTop - 0.01;

      if (tongueVisible && !tongueDetected) {
        tongueDetected = true;
        if (resultPanel.style.display === "flex") {
          resultPanel.style.display = "none";
          instruction.style.opacity = "1";
        }
        instruction.textContent = "ЗАХОВАЙ ЯЗИК!";
        instruction.style.opacity = "1";
        startSpinning();
      } else if (!tongueVisible && tongueDetected) {
        tongueDetected = false;
        startHideSequence();
      }
    }

    function startSpinning() {
      if (spinning) return;
      spinning = true;
      slotsContainer.style.display = "flex";

      if (spinInterval) clearInterval(spinInterval);
      spinInterval = setInterval(() => {
        const slots = [s1, s2, s3];
        slots.forEach(slot => {
          const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
          slot.textContent = randomTask;
        });
      }, 100);
    }

    function startHideSequence() {
      if (spinInterval) {
        clearInterval(spinInterval);
        spinInterval = null;
      }
      spinning = false;

      setTimeout(() => {
        const slots = [s1, s2, s3];
        const randomSlot = slots[Math.floor(Math.random() * slots.length)];
        const finalText = randomSlot.textContent;

        slotsContainer.style.display = "none";
        instruction.style.opacity = "0";

        resultText.textContent = finalText;
        resultPanel.style.display = "flex";
      }, 300);
    }

    playAgainBtn.onclick = () => {
      resultPanel.style.display = "none";
      instruction.textContent = "ПОКАЖИ ЯЗИК!";
      instruction.style.opacity = "1";
      tongueDetected = false;
      if (spinInterval) {
        clearInterval(spinInterval);
        spinInterval = null;
      }
    };
  </script>
</body>
</html>
