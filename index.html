<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' https: 'unsafe-inline' https://cdn.jsdelivr.net https://storage.googleapis.com; style-src 'self' 'unsafe-inline'; media-src * blob: data:;">
    <title>üéÇ –ó –î–Ω–µ–º –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –í–∞–¥—ñ–∫! –ü–æ—Ü—ñ–ª—É–Ω–∫–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #000;
            color: white;
        }
        
        /* –í—ñ–¥–µ–æ —Ñ–æ–Ω */
        #video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            transform: scaleX(-1); /* –î–∑–µ—Ä–∫–∞–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è */
            z-index: 1;
        }
        
        /* Canvas –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è –ø–æ—Ü—ñ–ª—É–Ω–∫—ñ–≤ */
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        /* –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #startButton {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            font-size: 24px;
            background: linear-gradient(135deg, #ff6b6b, #ff4757);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }
        
        #title {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: clamp(24px, 5vw, 36px);
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            white-space: nowrap;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            gap: 25px;
        }
        
        .loader {
            width: 70px;
            height: 70px;
            border: 4px solid rgba(255, 107, 107, 0.3);
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        #smileIndicator {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .smile-icon {
            font-size: 24px;
            animation: bounce 1s infinite;
        }
        
        #debugPanel {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.85);
            color: #4ECDC4;
            padding: 12px 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 50;
            border: 1px solid #4ECDC4;
            max-width: 280px;
            backdrop-filter: blur(10px);
            line-height: 1.5;
        }
        
        .debug-value { color: #FFD700; font-weight: bold; }
        .debug-good { color: #4ECDC4; }
        .debug-bad { color: #FF6B6B; }
        
        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è */
        .control-btn {
            position: fixed;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:hover { transform: scale(1.1); background: rgba(255, 255, 255, 0.25); }
        
        #soundBtn { top: 20px; left: 20px; }
        #cameraBtn { bottom: 20px; left: 20px; }
        
        /* –ö–æ–Ω—Ñ–µ—Ç—ñ */
        .confetti {
            position: fixed;
            width: 15px;
            height: 15px;
            background: #ff6b6b;
            border-radius: 50%;
            pointer-events: none;
            z-index: 3;
            animation: confetti-fall 3s linear forwards;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        @keyframes kiss-pop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            #startButton { padding: 18px 35px; font-size: 22px; }
            #title { top: 5%; font-size: 22px; padding: 12px 20px; }
            #smileIndicator { bottom: 80px; font-size: 16px; padding: 10px 20px; }
            .control-btn { width: 45px; height: 45px; font-size: 18px; }
            #debugPanel { top: 10px; right: 10px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <!-- –í—ñ–¥–µ–æ –ø–æ—Ç–æ–∫ -->
    <video id="video" playsinline muted></video>
    
    <!-- Canvas –¥–ª—è –ø–æ—Ü—ñ–ª—É–Ω–∫—ñ–≤ -->
    <canvas id="canvas"></canvas>
    
    <!-- –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="title">üéÇ –ó –î–Ω–µ–º –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –í–∞–¥—ñ–∫!</div>
    <button id="startButton">üé¨ –ü–æ—á–∞—Ç–∏ –≤–µ—Å–µ–ª–æ—â—ñ!</button>
    <div id="smileIndicator">
        <span class="smile-icon">üòä</span>
        <span id="smileText">–ü–æ—Å–º—ñ—Ö–Ω—ñ—Ç—å—Å—è –¥–ª—è –ø–æ—Ü—ñ–ª—É–Ω–∫—ñ–≤!</span>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
    <button id="soundBtn" class="control-btn" title="–£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫">üîä</button>
    <button id="cameraBtn" class="control-btn" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É">üì∑</button>
    
    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è -->
    <div id="debugPanel">
        <div><strong>Face Tracking Debug</strong></div>
        <div>–°—Ç–∞—Ç—É—Å: <span id="debugStatus" class="debug-value">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></div>
        <div>–û–±–ª–∏—á—å: <span id="debugFaces" class="debug-value">0</span></div>
        <div>–ü–æ—Å–º—ñ—à–∫–∞: <span id="debugSmile" class="debug-value">0%</span></div>
        <div>–ü–æ—Ü—ñ–ª—É–Ω–∫–∏: <span id="debugKisses" class="debug-value">0</span></div>
    </div>
    
    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div id="loading">
        <div class="loader"></div>
        <div id="loadingText" style="font-size: 20px; text-align: center;">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –æ–±–ª–∏—á<br>
            <span style="font-size: 16px; opacity: 0.8;">–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏</span>
        </div>
    </div>

    <!-- –ê—É–¥—ñ–æ -->
    <audio id="backgroundMusic" loop>
        <source src="fon.mp3" type="audio/mpeg">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∞—É–¥—ñ–æ.
    </audio>
    <audio id="kissSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-kiss-2016.mp3" type="audio/mpeg">
    </audio>

    <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script>
    
    <script>
        (function() {
            'use strict';
            
            // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
            const CONFIG = {
                SMILE_THRESHOLD: 0.15, // –ü–æ—Ä—ñ–≥ –ø–æ—Å–º—ñ—à–∫–∏ (0-1)
                KISS_COOLDOWN: 1000,   // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ –ø–æ—Ü—ñ–ª—É–Ω–∫–∞–º–∏ (–º—Å)
                KISS_OPACITY: 0.7,     // –ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å –≤—ñ–¥–±–∏—Ç–∫—ñ–≤
                KISS_SIZE: 80,         // –†–æ–∑–º—ñ—Ä –ø–æ—Ü—ñ–ª—É–Ω–∫–∞ (–ø—ñ–∫—Å–µ–ª—ñ)
                SMOOTHING_FACTOR: 0.7, // –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è
                TARGET_FPS: 30         // –ß–∞—Å—Ç–æ—Ç–∞ –∫–∞–¥—Ä—ñ–≤
            };
            
            // –ö–ª—é—á–æ–≤—ñ —Ç–æ—á–∫–∏ –æ–±–ª–∏—á—á—è MediaPipe (–¥–ª—è –ø–æ—Å–º—ñ—à–∫–∏)
            const FACE_LANDMARKS = {
                LEFT_MOUTH: 61,   // –õ—ñ–≤–∏–π –∫—É—Ç–æ–∫ —Ä–æ—Ç–∞
                RIGHT_MOUTH: 291, // –ü—Ä–∞–≤–∏–π –∫—É—Ç–æ–∫ —Ä–æ—Ç–∞
                UPPER_LIP: 13,    // –í–µ—Ä—Ö–Ω—è –≥—É–±–∞ (—Ü–µ–Ω—Ç—Ä)
                LOWER_LIP: 14,    // –ù–∏–∂–Ω—è –≥—É–±–∞ (—Ü–µ–Ω—Ç—Ä)
                LEFT_CHEEK: 123,  // –õ—ñ–≤–∞ —â–æ–∫–∞
                RIGHT_CHEEK: 352  // –ü—Ä–∞–≤–∞ —â–æ–∫–∞
            };
            
            // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
            const elements = {
                video: document.getElementById('video'),
                canvas: document.getElementById('canvas'),
                startButton: document.getElementById('startButton'),
                title: document.getElementById('title'),
                smileIndicator: document.getElementById('smileIndicator'),
                loading: document.getElementById('loading'),
                loadingText: document.getElementById('loadingText'),
                soundBtn: document.getElementById('soundBtn'),
                cameraBtn: document.getElementById('cameraBtn'),
                backgroundMusic: document.getElementById('backgroundMusic'),
                kissSound: document.getElementById('kissSound')
            };
            
            // Canvas –∫–æ–Ω—Ç–µ–∫—Å—Ç
            const ctx = elements.canvas.getContext('2d');
            
            // –ï–ª–µ–º–µ–Ω—Ç–∏ –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
            const debug = {
                status: document.getElementById('debugStatus'),
                faces: document.getElementById('debugFaces'),
                smile: document.getElementById('debugSmile'),
                kisses: document.getElementById('debugKisses')
            };
            
            // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
            const state = {
                isRunning: false,
                isFrontCamera: true,
                isSoundOn: true,
                faceLandmarker: null,
                videoStream: null,
                animationFrameId: null,
                lastSmileTime: 0,
                kissCount: 0,
                lastRenderTime: 0,
                // –î–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø–æ—Å–º—ñ—à–∫–∏
                smileLevel: 0,
                lastSmileLevel: 0,
                // –ö–æ–ª–µ–∫—Ü—ñ—è –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–æ—Ü—ñ–ª—É–Ω–∫—ñ–≤
                activeKisses: [],
                // –ö–æ–Ω—Ñ–µ—Ç—ñ
                confetti: [],
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                stats: {
                    totalKisses: 0,
                    maxSmileLevel: 0,
                    smileDuration: 0
                }
            };
            
            // –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ü—ñ–ª—É–Ω–∫–∞ (—Å—Ç–≤–æ—Ä–∏–º–æ –ø—Ä–æ–≥—Ä–∞–º–Ω–æ)
            function createKissImage(size, color = '#ff6b6b') {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                
                // –ú–∞–ª—é—î–º–æ —Å—Ç–∏–ª—ñ–∑–æ–≤–∞–Ω–∏–π –≤—ñ–¥–±–∏—Ç–æ–∫ –≥—É–±
                ctx.fillStyle = color;
                ctx.globalAlpha = CONFIG.KISS_OPACITY;
                
                // –í–µ—Ä—Ö–Ω—è –≥—É–±–∞
                ctx.beginPath();
                ctx.ellipse(size/2, size/3, size/3, size/4, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // –ù–∏–∂–Ω—è –≥—É–±–∞
                ctx.beginPath();
                ctx.ellipse(size/2, size/1.8, size/2.5, size/3.5, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // –î–æ–¥–∞—î–º–æ —Ç–µ–∫—Å—Ç—É—Ä—É
                ctx.globalAlpha = 0.3;
                ctx.fillStyle = '#ff4757';
                for (let i = 0; i < 50; i++) {
                    const x = Math.random() * size;
                    const y = Math.random() * size;
                    const radius = Math.random() * 3;
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                return canvas;
            }
            
            // –ü–æ–ø–µ—Ä–µ–¥–Ω—å–æ —Å—Ç–≤–æ—Ä—é—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ü—ñ–ª—É–Ω–∫–∞
            const kissImage = createKissImage(CONFIG.KISS_SIZE, '#ff6b6b');
            
            // ========== –û–°–ù–û–í–ù–ò–ô –ö–õ–ê–° ==========
            class KissARApp {
                constructor() {
                    this.init();
                }
                
                async init() {
                    try {
                        this.setupEventListeners();
                        await this.setupCamera();
                        await this.initFaceTracking();
                        this.setupCanvas();
                        this.hideLoading();
                        this.startRenderLoop();
                        this.updateDebug('status', 'debug-good', '‚úÖ –ì–æ—Ç–æ–≤–æ');
                    } catch (error) {
                        this.handleError(error);
                    }
                }
                
                // ========== –ö–ê–ú–ï–†–ê ==========
                async setupCamera() {
                    try {
                        const constraints = {
                            video: {
                                facingMode: 'user',
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            }
                        };
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        elements.video.srcObject = stream;
                        state.videoStream = stream;
                        
                        await new Promise((resolve) => {
                            elements.video.onloadedmetadata = () => {
                                elements.video.play();
                                resolve();
                            };
                        });
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:', error);
                        throw new Error('CAMERA_ERROR');
                    }
                }
                
                async switchCamera() {
                    if (!state.videoStream) return;
                    
                    // –ó—É–ø–∏–Ω—è—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –ø–æ—Ç—ñ–∫
                    state.videoStream.getTracks().forEach(track => track.stop());
                    
                    // –ó–º—ñ–Ω—é—î–º–æ –∫–∞–º–µ—Ä—É
                    state.isFrontCamera = !state.isFrontCamera;
                    const facingMode = state.isFrontCamera ? 'user' : 'environment';
                    
                    try {
                        const constraints = {
                            video: {
                                facingMode: facingMode,
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            }
                        };
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        elements.video.srcObject = stream;
                        state.videoStream = stream;
                        
                        // –î–∑–µ—Ä–∫–∞–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ—ó –∫–∞–º–µ—Ä–∏
                        elements.video.style.transform = state.isFrontCamera ? 'scaleX(-1)' : 'scaleX(1)';
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏:', error);
                        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –∫–∞–º–µ—Ä–∏
                        state.isFrontCamera = !state.isFrontCamera;
                    }
                }
                
                // ========== FACE TRACKING (MediaPipe) ==========
                async initFaceTracking() {
                    try {
                        this.updateDebug('status', 'debug-value', '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è MediaPipe...');
                        
                        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ MediaPipe Face Landmarker
                        const vision = await FilesetResolver.forVisionTasks(
                            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
                        );
                        
                        state.faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                            baseOptions: {
                                modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                                delegate: "GPU"
                            },
                            outputFaceBlendshapes: true,
                            runningMode: "VIDEO",
                            numFaces: 1
                        });
                        
                        this.updateDebug('status', 'debug-good', '‚úÖ Face Tracking');
                        return true;
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ MediaPipe:', error);
                        this.updateDebug('status', 'debug-bad', '‚ùå –ü–æ–º–∏–ª–∫–∞');
                        throw error;
                    }
                }
                
                detectFace() {
                    if (!state.faceLandmarker || !state.isRunning) return;
                    
                    try {
                        if (elements.video.readyState < 2) return;
                        
                        const results = state.faceLandmarker.detectForVideo(elements.video, performance.now());
                        
                        if (results.faceLandmarks && results.faceLandmarks.length > 0) {
                            debug.faces.textContent = '1';
                            debug.faces.className = 'debug-value debug-good';
                            
                            const landmarks = results.faceLandmarks[0];
                            const blendshapes = results.faceBlendshapes?.[0] || [];
                            
                            // –ê–Ω–∞–ª—ñ–∑—É—î–º–æ –ø–æ—Å–º—ñ—à–∫—É
                            this.analyzeSmile(landmarks, blendshapes);
                            
                        } else {
                            debug.faces.textContent = '0';
                            debug.faces.className = 'debug-value debug-bad';
                            this.hideSmileIndicator();
                        }
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –¥–µ—Ç–µ–∫—Ü—ñ—ó –æ–±–ª–∏—á—á—è:', error);
                    }
                }
                
                analyzeSmile(landmarks, blendshapes) {
                    // –°–ø–æ—Å—ñ–± 1: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ blendshapes (–±—ñ–ª—å—à —Ç–æ—á–Ω–∏–π)
                    let smileScore = 0;
                    
                    if (blendshapes.length > 0) {
                        // –®—É–∫–∞—î–º–æ blendshape –¥–ª—è –ø–æ—Å–º—ñ—à–∫–∏
                        const mouthSmileLeft = blendshapes.find(b => b.categoryName === 'mouthSmileLeft');
                        const mouthSmileRight = blendshapes.find(b => b.categoryName === 'mouthSmileRight');
                        
                        if (mouthSmileLeft && mouthSmileRight) {
                            smileScore = (mouthSmileLeft.score + mouthSmileRight.score) / 2;
                        }
                    }
                    
                    // –°–ø–æ—Å—ñ–± 2: –Ø–∫—â–æ blendshapes –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–µ–æ–º–µ—Ç—Ä—ñ—é –≥—É–±
                    if (smileScore < 0.1 && landmarks.length > 400) {
                        const leftMouth = landmarks[FACE_LANDMARKS.LEFT_MOUTH];
                        const rightMouth = landmarks[FACE_LANDMARKS.RIGHT_MOUTH];
                        const upperLip = landmarks[FACE_LANDMARKS.UPPER_LIP];
                        const lowerLip = landmarks[FACE_LANDMARKS.LOWER_LIP];
                        
                        if (leftMouth && rightMouth && upperLip && lowerLip) {
                            // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —à–∏—Ä–∏–Ω—É —Ç–∞ –≤–∏—Å–æ—Ç—É —Ä–æ—Ç–∞
                            const mouthWidth = Math.abs(rightMouth.x - leftMouth.x);
                            const mouthHeight = Math.abs(lowerLip.y - upperLip.y);
                            
                            // –°–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –≤–∏—Å–æ—Ç–∏ –¥–æ —à–∏—Ä–∏–Ω–∏ (–ø–æ—Å–º—ñ—à–∫–∞ = –Ω–∏–∑—å–∫–µ —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è)
                            const ratio = mouthHeight / mouthWidth;
                            smileScore = Math.max(0, 1 - (ratio * 3));
                        }
                    }
                    
                    // –ó–≥–ª–∞–¥–∂—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è
                    state.smileLevel = state.lastSmileLevel * (1 - CONFIG.SMOOTHING_FACTOR) + 
                                      smileScore * CONFIG.SMOOTHING_FACTOR;
                    state.lastSmileLevel = state.smileLevel;
                    
                    // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                    const smilePercent = Math.round(state.smileLevel * 100);
                    debug.smile.textContent = `${smilePercent}%`;
                    debug.smile.className = smilePercent > 20 ? 'debug-value debug-good' : 'debug-value';
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø–æ—Å–º—ñ—Ö–∞—î—Ç—å—Å—è –ª—é–¥–∏–Ω–∞
                    if (state.smileLevel > CONFIG.SMILE_THRESHOLD) {
                        this.showSmileIndicator(smilePercent);
                        
                        // –î–æ–¥–∞—î–º–æ –ø–æ—Ü—ñ–ª—É–Ω–∫–∏, —è–∫—â–æ –ø–æ—Å–º—ñ—à–∫–∞ —Ç—Ä–∏–≤–∞—î
                        const now = Date.now();
                        if (now - state.lastSmileTime > CONFIG.KISS_COOLDOWN) {
                            this.addKisses(landmarks);
                            state.lastSmileTime = now;
                        }
                    } else {
                        this.hideSmileIndicator();
                    }
                    
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    if (state.smileLevel > state.stats.maxSmileLevel) {
                        state.stats.maxSmileLevel = state.smileLevel;
                    }
                }
                
                // ========== –ü–û–¶–Ü–õ–£–ù–ö–ò ==========
                addKisses(landmarks) {
                    if (landmarks.length < 400) return;
                    
                    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —â—ñ–∫
                    const leftCheek = landmarks[FACE_LANDMARKS.LEFT_CHEEK];
                    const rightCheek = landmarks[FACE_LANDMARKS.RIGHT_CHEEK];
                    
                    if (!leftCheek || !rightCheek) return;
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤ –ø—ñ–∫—Å–µ–ª—ñ
                    const videoWidth = elements.video.videoWidth;
                    const videoHeight = elements.video.videoHeight;
                    const canvasWidth = elements.canvas.width;
                    const canvasHeight = elements.canvas.height;
                    
                    // –õ—ñ–≤–∞ —â–æ–∫–∞
                    const leftX = (state.isFrontCamera ? (1 - leftCheek.x) : leftCheek.x) * videoWidth;
                    const leftY = leftCheek.y * videoHeight;
                    
                    // –ü—Ä–∞–≤–∞ —â–æ–∫–∞
                    const rightX = (state.isFrontCamera ? (1 - rightCheek.x) : rightCheek.x) * videoWidth;
                    const rightY = rightCheek.y * videoHeight;
                    
                    // –ú–∞—Å—à—Ç–∞–±—É—î–º–æ –¥–æ —Ä–æ–∑–º—ñ—Ä—É canvas
                    const scaleX = canvasWidth / videoWidth;
                    const scaleY = canvasHeight / videoHeight;
                    
                    // –î–æ–¥–∞—î–º–æ –ø–æ—Ü—ñ–ª—É–Ω–∫–∏ –Ω–∞ –æ–±–∏–¥–≤—ñ —â–æ–∫–∏
                    const kisses = [
                        {
                            x: leftX * scaleX,
                            y: leftY * scaleY,
                            size: CONFIG.KISS_SIZE * (0.8 + Math.random() * 0.4),
                            rotation: Math.random() * Math.PI * 2,
                            opacity: CONFIG.KISS_OPACITY,
                            life: 1.0,
                            decay: 0.01 + Math.random() * 0.02
                        },
                        {
                            x: rightX * scaleX,
                            y: rightY * scaleY,
                            size: CONFIG.KISS_SIZE * (0.8 + Math.random() * 0.4),
                            rotation: Math.random() * Math.PI * 2,
                            opacity: CONFIG.KISS_OPACITY,
                            life: 1.0,
                            decay: 0.01 + Math.random() * 0.02
                        }
                    ];
                    
                    state.activeKisses.push(...kisses);
                    state.kissCount += 2;
                    state.stats.totalKisses += 2;
                    
                    // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                    debug.kisses.textContent = state.stats.totalKisses;
                    
                    // –í—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –∑–≤—É–∫ –ø–æ—Ü—ñ–ª—É–Ω–∫—É
                    this.playKissSound();
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ñ–µ—Ç—ñ
                    this.createConfetti(kisses[0].x, kisses[0].y);
                    this.createConfetti(kisses[1].x, kisses[1].y);
                }
                
                updateKisses() {
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∞ –º–∞–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ –ø–æ—Ü—ñ–ª—É–Ω–∫–∏
                    for (let i = state.activeKisses.length - 1; i >= 0; i--) {
                        const kiss = state.activeKisses[i];
                        
                        // –ó–º–µ–Ω—à—É—î–º–æ –∂–∏—Ç—Ç—è
                        kiss.life -= kiss.decay;
                        kiss.opacity = CONFIG.KISS_OPACITY * kiss.life;
                        
                        if (kiss.life <= 0) {
                            // –í–∏–¥–∞–ª—è—î–º–æ –ø–æ—Ü—ñ–ª—É–Ω–∫–∏, —è–∫—ñ –∑–Ω–∏–∫–ª–∏
                            state.activeKisses.splice(i, 1);
                            continue;
                        }
                        
                        // –ú–∞–ª—é—î–º–æ –ø–æ—Ü—ñ–ª—É–Ω–æ–∫
                        this.drawKiss(kiss);
                    }
                }
                
                drawKiss(kiss) {
                    ctx.save();
                    ctx.translate(kiss.x, kiss.y);
                    ctx.rotate(kiss.rotation);
                    ctx.globalAlpha = kiss.opacity;
                    
                    // –ú–∞–ª—é—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ü—ñ–ª—É–Ω–∫–∞
                    ctx.drawImage(
                        kissImage,
                        -kiss.size / 2,
                        -kiss.size / 2,
                        kiss.size,
                        kiss.size
                    );
                    
                    // –î–æ–¥–∞—î–º–æ —Å–≤—ñ—Ç—ñ–Ω–Ω—è
                    ctx.globalAlpha = kiss.opacity * 0.3;
                    ctx.fillStyle = '#ff6b6b';
                    ctx.beginPath();
                    ctx.arc(0, 0, kiss.size / 1.5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                }
                
                // ========== –ö–û–ù–§–ï–¢–Ü ==========
                createConfetti(x, y) {
                    for (let i = 0; i < 15; i++) {
                        state.confetti.push({
                            x: x,
                            y: y,
                            vx: (Math.random() - 0.5) * 10,
                            vy: Math.random() * -15 - 5,
                            size: Math.random() * 8 + 4,
                            color: `hsl(${Math.random() * 60 + 0}, 100%, 65%)`, // –ß–µ—Ä–≤–æ–Ω–∏–π —Å–ø–µ–∫—Ç—Ä
                            life: 1.0,
                            gravity: 0.4,
                            rotation: Math.random() * Math.PI * 2,
                            spin: (Math.random() - 0.5) * 0.3
                        });
                    }
                }
                
                updateConfetti() {
                    for (let i = state.confetti.length - 1; i >= 0; i--) {
                        const particle = state.confetti[i];
                        
                        particle.vy += particle.gravity;
                        particle.x += particle.vx;
                        particle.y += particle.vy;
                        particle.life -= 0.015;
                        particle.rotation += particle.spin;
                        
                        if (particle.life <= 0) {
                            state.confetti.splice(i, 1);
                            continue;
                        }
                        
                        // –ú–∞–ª—é—î–º–æ –∫–æ–Ω—Ñ–µ—Ç—ñ
                        ctx.save();
                        ctx.globalAlpha = particle.life;
                        ctx.translate(particle.x, particle.y);
                        ctx.rotate(particle.rotation);
                        ctx.fillStyle = particle.color;
                        ctx.fillRect(-particle.size/2, -particle.size/2, particle.size, particle.size);
                        ctx.restore();
                    }
                }
                
                // ========== –ê–£–î–Ü–û ==========
                playKissSound() {
                    if (!state.isSoundOn) return;
                    
                    try {
                        elements.kissSound.currentTime = 0;
                        elements.kissSound.play().catch(e => console.log('–ó–≤—É–∫ –ø–æ—Ü—ñ–ª—É–Ω–∫—É –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–∏–≤—Å—è:', e));
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤—É–∫—É:', error);
                    }
                }
                
                toggleSound() {
                    state.isSoundOn = !state.isSoundOn;
                    
                    if (state.isSoundOn) {
                        elements.backgroundMusic.play().catch(e => console.log('–§–æ–Ω–æ–≤–∞ –º—É–∑–∏–∫–∞:', e));
                        elements.soundBtn.textContent = 'üîä';
                    } else {
                        elements.backgroundMusic.pause();
                        elements.soundBtn.textContent = 'üîá';
                    }
                }
                
                // ========== –Ü–ù–¢–ï–†–§–ï–ô–° ==========
                showSmileIndicator(percent) {
                    const smileText = percent > 50 ? '–ß—É–¥–æ–≤–∞ –ø–æ—Å–º—ñ—à–∫–∞! üíã' : 
                                     percent > 30 ? '–¢—Ä–∏–º–∞–π—Ç–µ –ø–æ—Å–º—ñ—à–∫—É! üòä' : 
                                     '–ü–æ—Å–º—ñ—Ö–Ω—ñ—Ç—å—Å—è –¥–ª—è –ø–æ—Ü—ñ–ª—É–Ω–∫—ñ–≤!';
                    
                    document.getElementById('smileText').textContent = smileText;
                    elements.smileIndicator.style.display = 'flex';
                    elements.smileIndicator.style.animation = 'fade-in 0.3s ease';
                }
                
                hideSmileIndicator() {
                    elements.smileIndicator.style.display = 'none';
                }
                
                showLoading(text) {
                    elements.loadingText.textContent = text;
                    elements.loading.style.display = 'flex';
                }
                
                hideLoading() {
                    elements.loading.style.display = 'none';
                    elements.startButton.style.display = 'none';
                    elements.title.style.display = 'block';
                    state.isRunning = true;
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø—É—Å–∫–∞—î–º–æ –º—É–∑–∏–∫—É
                    setTimeout(() => {
                        if (state.isSoundOn) {
                            elements.backgroundMusic.play().catch(e => console.log('–ú—É–∑–∏–∫–∞:', e));
                        }
                    }, 1000);
                }
                
                // ========== CANVAS ==========
                setupCanvas() {
                    elements.canvas.width = window.innerWidth;
                    elements.canvas.height = window.innerHeight;
                    
                    // –†–µ—Å–∞–π–∑ canvas –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
                    window.addEventListener('resize', () => {
                        elements.canvas.width = window.innerWidth;
                        elements.canvas.height = window.innerHeight;
                    });
                }
                
                clearCanvas() {
                    ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                }
                
                // ========== –ì–õ–ê–í–ù–ò–ô –¶–ò–ö–õ ==========
                startRenderLoop() {
                    const render = (currentTime) => {
                        if (currentTime - state.lastRenderTime >= 1000 / CONFIG.TARGET_FPS) {
                            if (state.isRunning) {
                                this.clearCanvas();
                                this.detectFace();
                                this.updateKisses();
                                this.updateConfetti();
                            }
                            state.lastRenderTime = currentTime;
                        }
                        state.animationFrameId = requestAnimationFrame(render);
                    };
                    render(performance.now());
                }
                
                // ========== –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô ==========
                setupEventListeners() {
                    // –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É
                    elements.startButton.addEventListener('click', () => this.hideLoading());
                    
                    // –ó–≤—É–∫
                    elements.soundBtn.addEventListener('click', () => this.toggleSound());
                    
                    // –ö–∞–º–µ—Ä–∞
                    elements.cameraBtn.addEventListener('click', () => this.switchCamera());
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É (–¥–ª—è —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞—É–¥—ñ–æ)
                    document.addEventListener('click', () => {
                        if (!state.isRunning) {
                            this.hideLoading();
                        }
                        // –†–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ –∞—É–¥—ñ–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                        if (state.isSoundOn) {
                            elements.backgroundMusic.play().catch(() => {});
                        }
                    }, { once: true });
                }
                
                // ========== –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á ==========
                updateDebug(elementId, className, text) {
                    if (debug[elementId]) {
                        debug[elementId].textContent = text;
                        debug[elementId].className = `debug-value ${className}`;
                    }
                }
                
                handleError(error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞—Ç–∫—É:', error);
                    
                    let message = '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞';
                    let details = '';
                    
                    if (error.message === 'CAMERA_ERROR') {
                        message = '–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏';
                        details = '–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
                    } else if (error.message.includes('MediaPipe')) {
                        message = '–ü–æ–º–∏–ª–∫–∞ MediaPipe';
                        details = '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
                    }
                    
                    elements.loading.innerHTML = `
                        <div style="color: #ff4757; font-size: 24px; margin-bottom: 15px;">${message}</div>
                        <div style="color: white; font-size: 16px; margin-bottom: 20px; line-height: 1.4;">${details}</div>
                        <button onclick="location.reload()" style="
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #ff6b6b, #ff4757);
                            border: none;
                            color: white;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                            border-radius: 25px;
                            transition: all 0.3s ease;
                        ">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
                    `;
                }
                
                cleanup() {
                    if (state.animationFrameId) {
                        cancelAnimationFrame(state.animationFrameId);
                    }
                    if (state.videoStream) {
                        state.videoStream.getTracks().forEach(track => track.stop());
                    }
                    if (state.faceLandmarker) {
                        state.faceLandmarker.close();
                    }
                }
            }
            
            // –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É
            window.addEventListener('DOMContentLoaded', () => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    elements.loading.innerHTML = `
                        <div style="color: #ff4757; font-size: 24px; margin-bottom: 15px;">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î</div>
                        <div style="color: white; font-size: 16px; margin-bottom: 20px; line-height: 1.4;">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏.<br>
                            –°–ø—Ä–æ–±—É–π—Ç–µ Chrome, Edge –∞–±–æ Safari.
                        </div>
                    `;
                    return;
                }
                
                const app = new KissARApp();
                
                // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
                window.addEventListener('beforeunload', () => app.cleanup());
            });
            
        })();
    </script>
</body>
</html>
