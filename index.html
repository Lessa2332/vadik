<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="format-detection" content="telephone=no">
    <title>üéÇ –ó –î–Ω–µ–º –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è! </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            background: #000;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* –ë–µ–∑–ø–µ—á–Ω–∞ –∑–æ–Ω–∞ –¥–ª—è iPhone X+ */
        @supports (padding: max(0px)) {
            body {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* –í—ñ–¥–µ–æ —Ñ–æ–Ω */
        #video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            transform: scaleX(-1);
            z-index: 1;
            -webkit-transform: scaleX(-1);
        }
        
        /* Canvas –¥–ª—è –µ–º–æ–¥–∂—ñ */
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        /* –ì–æ–ª–æ–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞ */
        #startButton {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: min(5vh, 25px) min(10vw, 50px);
            font-size: clamp(20px, 5vw, 28px);
            background: linear-gradient(135deg, #ff6b6b, #ff4757);
            border: none;
            border-radius: max(2vw, 15px);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
            box-shadow: 0 2vh 4vh rgba(255, 107, 107, 0.6),
                        0 0 0 max(0.5vw, 4px) rgba(255, 107, 107, 0.3),
                        0 0 0 max(1vw, 8px) rgba(255, 107, 107, 0.1);
            animation: pulse-glow 2s infinite, bounce 3s infinite;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            width: min(90vw, 400px);
            text-align: center;
            -webkit-appearance: none;
            appearance: none;
        }
        
        #startButton:hover, #startButton:active {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 3vh 5vh rgba(255, 107, 107, 0.8),
                        0 0 0 max(0.7vw, 6px) rgba(255, 107, 107, 0.4),
                        0 0 0 max(1.5vw, 12px) rgba(255, 107, 107, 0.2);
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∑–≤—É–∫—É */
        #soundBtn {
            position: fixed;
            top: max(env(safe-area-inset-top, 20px), 20px);
            left: max(env(safe-area-inset-left, 20px), 20px);
            width: min(12vw, 70px);
            height: min(12vw, 70px);
            min-width: 55px;
            min-height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            border: max(0.4vw, 3px) solid white;
            color: white;
            font-size: clamp(22px, 5vw, 30px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2vh 3vh rgba(78, 205, 196, 0.7),
                        0 0 0 max(0.4vw, 3px) rgba(255, 255, 255, 0.5);
            animation: sound-pulse 1.5s infinite;
            font-weight: bold;
            -webkit-appearance: none;
            appearance: none;
        }
        
        #soundBtn:hover, #soundBtn:active {
            transform: scale(1.1);
            box-shadow: 0 3vh 4vh rgba(78, 205, 196, 0.9),
                        0 0 0 max(0.6vw, 4px) rgba(255, 255, 255, 0.7);
        }
        
        #soundBtn.muted {
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            box-shadow: 0 2vh 3vh rgba(255, 107, 107, 0.7),
                        0 0 0 max(0.4vw, 3px) rgba(255, 255, 255, 0.5);
        }
        
        #title {
            position: fixed;
            top: clamp(5%, env(safe-area-inset-top, 30px), 10%);
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: clamp(20px, 5vw, 42px);
            font-weight: bold;
            text-shadow: 0 1vh 2vh rgba(0,0,0,0.9);
            z-index: 10;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 183, 77, 0.9));
            padding: clamp(15px, 3vw, 20px) clamp(20px, 5vw, 35px);
            border-radius: max(2vw, 15px);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: max(0.4vw, 3px) solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 3vh 6vh rgba(0,0,0,0.5);
            white-space: nowrap;
            animation: title-float 4s infinite ease-in-out;
            max-width: 95vw;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #smileIndicator {
            position: fixed;
            bottom: max(12vh, 120px);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 183, 77, 0.9));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: white;
            padding: clamp(10px, 2vw, 15px) clamp(15px, 4vw, 30px);
            border-radius: max(3vw, 20px);
            border: max(0.4vw, 3px) solid rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            gap: clamp(10px, 3vw, 15px);
            z-index: 10;
            font-size: clamp(16px, 4vw, 20px);
            font-weight: bold;
            box-shadow: 0 2vh 4vh rgba(0,0,0,0.4);
            animation: slide-up 0.5s ease;
            width: min(90vw, 400px);
            justify-content: center;
        }
        
        .smile-icon {
            font-size: clamp(24px, 6vw, 32px);
            animation: bounce 1s infinite;
        }
        
        /* –î–µ–±–∞–≥-–ø–∞–Ω–µ–ª—å */
        #debugPanel {
            position: fixed;
            top: max(100px, env(safe-area-inset-top, 30px));
            right: max(10px, env(safe-area-inset-right, 10px));
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: min(2vw, 10px);
            border-radius: max(1vw, 10px);
            font-family: monospace;
            font-size: clamp(10px, 2.5vw, 12px);
            z-index: 1000;
            display: block;
            max-width: min(90vw, 300px);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            gap: min(5vh, 30px);
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .loader {
            width: min(20vw, 80px);
            height: min(20vw, 80px);
            border: max(0.6vw, 5px) solid rgba(255, 107, 107, 0.3);
            border-top: max(0.6vw, 5px) solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 3vh rgba(255, 107, 107, 0.5);
        }
        
        /* –ï–º–æ–¥–∂—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó */
        .emoji-float {
            position: fixed;
            font-size: clamp(40px, 10vw, 70px);
            pointer-events: none;
            z-index: 3;
            animation: emoji-float 2s ease-out forwards;
            text-shadow: 0 0 3vh rgba(255, 107, 107, 0.9);
            filter: drop-shadow(0 0.5vh 1.5vh rgba(0,0,0,0.3));
            -webkit-filter: drop-shadow(0 0.5vh 1.5vh rgba(0,0,0,0.3));
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä–∏ */
        #cameraBtn {
            position: fixed;
            bottom: max(3vh, 30px);
            right: max(2vw, 30px);
            width: min(12vw, 60px);
            height: min(12vw, 60px);
            min-width: 50px;
            min-height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: max(0.3vw, 2px) solid rgba(255, 255, 255, 0.5);
            color: white;
            font-size: clamp(20px, 4vw, 28px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 1vh 3vh rgba(0, 0, 0, 0.3);
            -webkit-appearance: none;
            appearance: none;
        }
        
        #cameraBtn:hover, #cameraBtn:active {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */
        .message {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: clamp(12px, 3vw, 15px) clamp(20px, 5vw, 25px);
            border-radius: max(2vw, 15px);
            z-index: 1000;
            font-weight: bold;
            text-align: center;
            max-width: min(90vw, 400px);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2vh 4vh rgba(0,0,0,0.4);
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
        @keyframes pulse-glow {
            0% { 
                box-shadow: 0 2vh 4vh rgba(255, 107, 107, 0.6),
                            0 0 0 max(0.5vw, 4px) rgba(255, 107, 107, 0.3),
                            0 0 0 max(1vw, 8px) rgba(255, 107, 107, 0.1);
            }
            50% { 
                box-shadow: 0 3vh 5vh rgba(255, 107, 107, 0.8),
                            0 0 0 max(0.7vw, 6px) rgba(255, 107, 107, 0.4),
                            0 0 0 max(1.5vw, 12px) rgba(255, 107, 107, 0.2);
            }
            100% { 
                box-shadow: 0 2vh 4vh rgba(255, 107, 107, 0.6),
                            0 0 0 max(0.5vw, 4px) rgba(255, 107, 107, 0.3),
                            0 0 0 max(1vw, 8px) rgba(255, 107, 107, 0.1);
            }
        }
        
        @keyframes sound-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2vh 3vh rgba(78, 205, 196, 0.7),
                            0 0 0 max(0.4vw, 3px) rgba(255, 255, 255, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 3vh 4vh rgba(78, 205, 196, 0.9),
                            0 0 0 max(0.6vw, 4px) rgba(255, 255, 255, 0.7);
            }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-1vh); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes emoji-float {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-4vh) scale(1.3); opacity: 1; }
            80% { transform: translateY(-12vh) scale(1); opacity: 1; }
            100% { transform: translateY(-18vh) scale(0.8); opacity: 0; }
        }
        
        @keyframes title-float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-1vh); }
        }
        
        @keyframes slide-up {
            from { 
                opacity: 0;
                transform: translateX(-50%) translateY(3vh);
            }
            to { 
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateX(-50%) translateY(-2vh); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-2vh); }
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        @media (max-width: 320px) {
            #title {
                font-size: 18px;
                padding: 12px 18px;
            }
            
            #startButton {
                font-size: 18px;
                padding: 15px 25px;
            }
            
            #soundBtn {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –≤–∏—Å–æ–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ (iPhone X, 12, 13, 14) */
        @media (min-height: 800px) {
            #smileIndicator {
                bottom: 15vh;
            }
            
            #cameraBtn {
                bottom: 4vh;
            }
        }
        
        /* –õ–∞–Ω–¥—à–∞—Ñ—Ç —Ä–µ–∂–∏–º */
        @media (orientation: landscape) and (max-height: 500px) {
            #title {
                font-size: clamp(16px, 3vw, 24px);
                padding: 10px 15px;
                top: 5%;
            }
            
            #startButton {
                padding: 10px 20px;
                font-size: 18px;
            }
            
            #soundBtn {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }
            
            #smileIndicator {
                bottom: 8vh;
                font-size: 14px;
                padding: 8px 15px;
            }
            
            .smile-icon {
                font-size: 20px;
            }
        }
        
        /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            }
            
            #loading {
                background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
            }
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è Safari iOS */
        @supports (-webkit-touch-callout: none) {
            #title, #smileIndicator {
                -webkit-backdrop-filter: blur(20px);
            }
            
            #soundBtn, #cameraBtn {
                -webkit-backdrop-filter: blur(20px);
            }
        }
    </style>
</head>
<body>
    <!-- –í—ñ–¥–µ–æ –ø–æ—Ç–æ–∫ -->
    <video id="video" playsinline muted></video>
    
    <!-- Canvas –¥–ª—è –µ–º–æ–¥–∂—ñ -->
    <canvas id="canvas"></canvas>
    
    <!-- –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="title">üéÇ –ó –î–Ω–µ–º –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –í–∞–¥—ñ–∫! üíã</div>
    <button id="startButton">üé¨ –ü–û–ß–ê–¢–ò!</button>
    <div id="smileIndicator">
        <span class="smile-icon">üòä</span>
        <span id="smileText">–ü–æ—Å–º—ñ—Ö–Ω–∏—Å—è!</span>
    </div>
    
    <!-- –î–µ–±–∞–≥-–ø–∞–Ω–µ–ª—å -->
    <div id="debugPanel" style="display: none;">
        <div>–°–º–∞–π–ª —Ä—ñ–≤–µ–Ω—å: <span id="debugSmile">0</span></div>
        <div>–ü–æ—Å–º—ñ—à–∫–∞: <span id="debugIsSmiling">–Ω—ñ</span></div>
        <div>–ï–º–æ–¥–∂—ñ: <span id="debugEmojiCount">0</span></div>
        <div>–í—ñ–¥–Ω–æ—à–µ–Ω–Ω—è: <span id="debugRatio">0</span></div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∑–≤—É–∫—É -->
    <button id="soundBtn" class="control-btn" title="üéµ –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫">üîä</button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä–∏ -->
    <button id="cameraBtn" class="control-btn" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É">üì∑</button>
    
    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div id="loading">
        <div class="loader"></div>
        <div id="loadingText" style="font-size: clamp(18px, 4vw, 22px); text-align: center; max-width: min(90vw, 300px);">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –æ–±–ª–∏—á<br>
            <span style="font-size: clamp(14px, 3vw, 16px); opacity: 0.8; margin-top: 10px; display: block;">
                –ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
            </span>
        </div>
    </div>

    <!-- –ê–£–î–Ü–û -->
    <audio id="backgroundMusic" loop playsinline>
        <source src="fon.mp3" type="audio/mpeg">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∞—É–¥—ñ–æ.
    </audio>
    
    <!-- –†–µ–∑–µ—Ä–≤–Ω–µ –∞—É–¥—ñ–æ -->
    <audio id="backupMusic" loop playsinline>
        <source src="https://assets.mixkit.co/music/preview/mixkit-clear-sky-479.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="kissSound" preload="auto" playsinline>
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-kiss-2016.mp3" type="audio/mpeg">
    </audio>

    <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
    
    <script>
        (function() {
            'use strict';
            
            // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
            const CONFIG = {
                SMILE_THRESHOLD: 0.08,
                KISS_COOLDOWN: 300,
                EMOJI_SIZE: 75,
                EMOJI_DURATION: 2000,
                EMOJI_LIFETIME: 3000,
                SMOOTHING_FACTOR: 0.7,
                TARGET_FPS: 30,
                ONLY_EMOJIS: ['üíã', 'üòò'],
                DEBUG: false,
                MAX_EMOJIS_ON_SCREEN: 4,
                EMOJI_FADE_OUT_TIME: 1000,
                DETECTION_DELAY: 500
            };
            
            // –ö–ª—é—á–æ–≤—ñ —Ç–æ—á–∫–∏ –æ–±–ª–∏—á—á—è
            const FACE_LANDMARKS = {
                LEFT_MOUTH: 61,
                RIGHT_MOUTH: 291,
                UPPER_LIP: 13,
                LOWER_LIP: 14,
                LEFT_CHEEK: 123,
                RIGHT_CHEEK: 352
            };
            
            // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
            const elements = {
                video: document.getElementById('video'),
                canvas: document.getElementById('canvas'),
                startButton: document.getElementById('startButton'),
                title: document.getElementById('title'),
                smileIndicator: document.getElementById('smileIndicator'),
                loading: document.getElementById('loading'),
                loadingText: document.getElementById('loadingText'),
                soundBtn: document.getElementById('soundBtn'),
                cameraBtn: document.getElementById('cameraBtn'),
                backgroundMusic: document.getElementById('backgroundMusic'),
                backupMusic: document.getElementById('backupMusic'),
                kissSound: document.getElementById('kissSound'),
                debugPanel: document.getElementById('debugPanel'),
                debugSmile: document.getElementById('debugSmile'),
                debugIsSmiling: document.getElementById('debugIsSmiling'),
                debugEmojiCount: document.getElementById('debugEmojiCount'),
                debugRatio: document.getElementById('debugRatio')
            };
            
            // Canvas –∫–æ–Ω—Ç–µ–∫—Å—Ç
            const ctx = elements.canvas.getContext('2d');
            
            // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
            const state = {
                isRunning: false,
                isFrontCamera: true,
                isSoundOn: false,
                faceMesh: null,
                videoStream: null,
                animationFrameId: null,
                lastSmileTime: 0,
                lastRenderTime: 0,
                smileLevel: 0,
                lastSmileLevel: 0,
                activeEmojis: [],
                floatingEmojis: [],
                confetti: [],
                stats: { totalKisses: 0, maxSmileLevel: 0 },
                lastResults: null,
                audioContext: null,
                isAudioUnlocked: false,
                isSmiling: false,
                smileStartTime: 0,
                showDebug: CONFIG.DEBUG,
                deviceType: getDeviceType(),
                isLandscape: window.innerWidth > window.innerHeight
            };
            
            // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏–ø—É –ø—Ä–∏—Å—Ç—Ä–æ—é
            function getDeviceType() {
                const ua = navigator.userAgent;
                if (/iPhone|iPad|iPod/i.test(ua)) return 'ios';
                if (/Android/i.test(ua)) return 'android';
                return 'desktop';
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏
            function checkCompatibility() {
                const issues = [];
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    issues.push('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∫–∞–º–µ—Ä—É');
                }
                
                if (!window.FaceMesh) {
                    issues.push('–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –æ–±–ª–∏—á –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∞—Å—å');
                }
                
                return issues;
            }
            
            // ========== –ê–£–î–Ü–û –°–ò–°–¢–ï–ú–ê ==========
            function unlockAudio() {
                if (state.isAudioUnlocked) return;
                
                try {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    if (state.audioContext.state === 'suspended') {
                        state.audioContext.resume();
                    }
                    
                    if (state.isSoundOn) {
                        playBackgroundMusic();
                    }
                    
                    state.isAudioUnlocked = true;
                    console.log('üîä –ê—É–¥—ñ–æ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ!');
                    
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∞—É–¥—ñ–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É:', error);
                    state.isAudioUnlocked = true;
                }
            }
            
            function playBackgroundMusic() {
                if (!state.isSoundOn) return;
                
                // –î–ª—è iOS –ø–æ—Ç—Ä—ñ–±–µ–Ω –æ—Å–æ–±–ª–∏–≤–∏–π –ø—ñ–¥—Ö—ñ–¥
                if (state.deviceType === 'ios') {
                    elements.backgroundMusic.volume = 0.5;
                }
                
                elements.backgroundMusic.play().then(() => {
                    console.log('üéµ –ú—É–∑–∏–∫–∞ –≥—Ä–∞—î');
                }).catch(error => {
                    console.log('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –æ—Å–Ω–æ–≤–Ω—É –º—É–∑–∏–∫—É:', error.message);
                    elements.backupMusic.play().then(() => {
                        console.log('üéµ –†–µ–∑–µ—Ä–≤–Ω–∞ –º—É–∑–∏–∫–∞ –≥—Ä–∞—î');
                        elements.soundBtn.innerHTML = 'üéµ';
                    }).catch(backupError => {
                        console.log('‚ùå –†–µ–∑–µ—Ä–≤–Ω–∞ –º—É–∑–∏–∫–∞ —Ç–µ–∂ –Ω–µ –ø—Ä–∞—Ü—é—î:', backupError.message);
                        elements.soundBtn.innerHTML = 'üîá';
                        state.isSoundOn = false;
                    });
                });
            }
            
            function toggleSound() {
                state.isSoundOn = !state.isSoundOn;
                
                if (!state.isAudioUnlocked) {
                    unlockAudio();
                }
                
                if (state.isSoundOn) {
                    elements.soundBtn.innerHTML = 'üîä';
                    elements.soundBtn.classList.remove('muted');
                    elements.soundBtn.title = 'üîä –ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ';
                    playBackgroundMusic();
                    showMessage('üéµ –ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ!');
                } else {
                    elements.soundBtn.innerHTML = 'üîá';
                    elements.soundBtn.classList.add('muted');
                    elements.soundBtn.title = 'üîá –ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ';
                    elements.backgroundMusic.pause();
                    elements.backupMusic.pause();
                    showMessage('üîá –ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ');
                }
            }
            
            function showMessage(text, duration = 3000) {
                const existingMessages = document.querySelectorAll('.message');
                existingMessages.forEach(msg => msg.remove());
                
                const message = document.createElement('div');
                message.className = 'message';
                message.textContent = text;
                message.style.animation = 'fade-in-out 3s forwards';
                
                document.body.appendChild(message);
                
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, duration);
            }
            
            function updateDebugInfo() {
                if (!state.showDebug) return;
                
                elements.debugSmile.textContent = state.smileLevel.toFixed(3);
                elements.debugIsSmiling.textContent = state.isSmiling ? '–¢–ê–ö' : '–Ω—ñ';
                elements.debugEmojiCount.textContent = state.activeEmojis.length;
                elements.debugPanel.style.display = 'block';
            }
            
            // ========== –û–°–ù–û–í–ù–ò–ô –ö–õ–ê–° ==========
            class KissARApp {
                constructor() {
                    this.init();
                }
                
                async init() {
                    try {
                        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
                        const issues = checkCompatibility();
                        if (issues.length > 0) {
                            this.showCompatibilityError(issues);
                            return;
                        }
                        
                        this.setupEventListeners();
                        await this.setupCamera();
                        await this.initFaceMesh();
                        this.setupCanvas();
                        this.setupOrientation();
                        this.hideLoading();
                        this.startRenderLoop();
                        
                    } catch (error) {
                        this.handleError(error);
                    }
                }
                
                // ========== –ö–ê–ú–ï–†–ê ==========
                async setupCamera() {
                    try {
                        // –î–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É —Ä–æ–∑–¥—ñ–ª—å–Ω—É –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å
                        let constraints;
                        
                        if (state.deviceType === 'ios' || state.deviceType === 'android') {
                            constraints = {
                                video: {
                                    facingMode: 'user',
                                    width: { ideal: 720 },
                                    height: { ideal: 1280 },
                                    frameRate: { ideal: 30 }
                                }
                            };
                        } else {
                            constraints = {
                                video: {
                                    facingMode: 'user',
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 },
                                    frameRate: { ideal: 30 }
                                }
                            };
                        }
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        elements.video.srcObject = stream;
                        state.videoStream = stream;
                        
                        await new Promise((resolve, reject) => {
                            elements.video.onloadedmetadata = () => {
                                elements.video.play().then(resolve).catch(reject);
                            };
                            elements.video.onerror = reject;
                        });
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:', error);
                        throw new Error('CAMERA_ERROR');
                    }
                }
                
                async switchCamera() {
                    if (!state.videoStream) return;
                    
                    state.videoStream.getTracks().forEach(track => track.stop());
                    state.isFrontCamera = !state.isFrontCamera;
                    
                    try {
                        const constraints = {
                            video: {
                                facingMode: state.isFrontCamera ? 'user' : 'environment',
                                width: { ideal: 720 },
                                height: { ideal: 1280 },
                                frameRate: { ideal: 30 }
                            }
                        };
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        elements.video.srcObject = stream;
                        state.videoStream = stream;
                        
                        elements.video.style.transform = state.isFrontCamera ? 'scaleX(-1)' : 'scaleX(1)';
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏:', error);
                        state.isFrontCamera = !state.isFrontCamera;
                        showMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É');
                    }
                }
                
                // ========== FACE MESH ==========
                async initFaceMesh() {
                    try {
                        state.faceMesh = new FaceMesh({
                            locateFile: (file) => {
                                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                            }
                        });
                        
                        state.faceMesh.setOptions({
                            maxNumFaces: 1,
                            refineLandmarks: true,
                            minDetectionConfidence: 0.5,
                            minTrackingConfidence: 0.5
                        });
                        
                        state.faceMesh.onResults((results) => {
                            state.lastResults = results;
                        });
                        
                        const camera = new Camera(elements.video, {
                            onFrame: async () => {
                                if (state.faceMesh && state.isRunning) {
                                    await state.faceMesh.send({image: elements.video});
                                }
                            },
                            width: 720,
                            height: 1280
                        });
                        
                        await camera.start();
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ Face Mesh:', error);
                        throw error;
                    }
                }
                
                detectFace() {
                    if (!state.lastResults || !state.isRunning) return;
                    
                    const results = state.lastResults;
                    
                    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                        const landmarks = results.multiFaceLandmarks[0];
                        this.analyzeSmile(landmarks);
                    } else {
                        this.hideSmileIndicator();
                        state.isSmiling = false;
                    }
                    
                    updateDebugInfo();
                }
                
                analyzeSmile(landmarks) {
                    if (!landmarks || landmarks.length < 400) return;
                    
                    const leftMouth = landmarks[FACE_LANDMARKS.LEFT_MOUTH];
                    const rightMouth = landmarks[FACE_LANDMARKS.RIGHT_MOUTH];
                    const upperLip = landmarks[FACE_LANDMARKS.UPPER_LIP];
                    const lowerLip = landmarks[FACE_LANDMARKS.LOWER_LIP];
                    
                    if (!leftMouth || !rightMouth || !upperLip || !lowerLip) return;
                    
                    const mouthWidth = Math.abs(rightMouth.x - leftMouth.x);
                    const mouthHeight = Math.abs(lowerLip.y - upperLip.y);
                    
                    const ratio = mouthHeight / mouthWidth;
                    
                    if (state.showDebug) {
                        elements.debugRatio.textContent = ratio.toFixed(3);
                    }
                    
                    let smileScore = Math.max(0, (0.4 - ratio) * 5);
                    
                    state.smileLevel = state.lastSmileLevel * (1 - CONFIG.SMOOTHING_FACTOR) + 
                                      smileScore * CONFIG.SMOOTHING_FACTOR;
                    state.lastSmileLevel = state.smileLevel;
                    
                    const smilePercent = Math.round(state.smileLevel * 100);
                    const now = Date.now();
                    
                    const wasSmiling = state.isSmiling;
                    
                    const ratioThreshold = 0.25;
                    state.isSmiling = ratio < ratioThreshold;
                    
                    if (state.isSmiling) {
                        if (!wasSmiling) {
                            state.smileStartTime = now;
                        }
                        
                        this.showSmileIndicator(smilePercent);
                        
                        if (now - state.lastSmileTime > CONFIG.KISS_COOLDOWN && 
                            now - state.smileStartTime > CONFIG.DETECTION_DELAY) {
                            this.addEmojis(landmarks);
                            state.lastSmileTime = now;
                        }
                    } else {
                        this.hideSmileIndicator();
                        this.stopAddingNewEmojis();
                    }
                }
                
                stopAddingNewEmojis() {
                    // –ù–µ –¥–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ –µ–º–æ–¥–∂—ñ –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –ø–æ—Å–º—ñ—à–∫–∏
                }
                
                // ========== –ï–ú–û–î–ñ–Ü ==========
                addEmojis(landmarks) {
                    if (landmarks.length < 400) return;
                    
                    // –û–±–º–µ–∂–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –µ–º–æ–¥–∂—ñ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ
                    if (state.activeEmojis.length >= CONFIG.MAX_EMOJIS_ON_SCREEN) {
                        state.activeEmojis.shift();
                    }
                    
                    const leftCheek = landmarks[FACE_LANDMARKS.LEFT_CHEEK];
                    const rightCheek = landmarks[FACE_LANDMARKS.RIGHT_CHEEK];
                    
                    if (!leftCheek || !rightCheek) return;
                    
                    const emoji = CONFIG.ONLY_EMOJIS[Math.floor(Math.random() * CONFIG.ONLY_EMOJIS.length)];
                    
                    const videoWidth = elements.video.videoWidth;
                    const videoHeight = elements.video.videoHeight;
                    const canvasWidth = elements.canvas.width;
                    const canvasHeight = elements.canvas.height;
                    
                    // –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                    const leftX = (state.isFrontCamera ? (1 - leftCheek.x) : leftCheek.x) * videoWidth;
                    const leftY = leftCheek.y * videoHeight;
                    const rightX = (state.isFrontCamera ? (1 - rightCheek.x) : rightCheek.x) * videoWidth;
                    const rightY = rightCheek.y * videoHeight;
                    
                    const scaleX = canvasWidth / videoWidth;
                    const scaleY = canvasHeight / videoHeight;
                    
                    // –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –µ–º–æ–¥–∂—ñ
                    const emojiSize = Math.min(
                        CONFIG.EMOJI_SIZE * (canvasWidth / 720),
                        CONFIG.EMOJI_SIZE * (canvasHeight / 1280)
                    );
                    
                    // –î–æ–¥–∞—î–º–æ –µ–º–æ–¥–∂—ñ –Ω–∞ —â–æ–∫–∏
                    state.activeEmojis.push({
                        x: leftX * scaleX,
                        y: leftY * scaleY,
                        emoji: emoji,
                        size: emojiSize * (0.9 + Math.random() * 0.2),
                        rotation: Math.random() * 0.2 - 0.1,
                        opacity: 1,
                        life: 1.0,
                        decay: 0.01,
                        createdAt: Date.now(),
                        maxLifetime: CONFIG.EMOJI_LIFETIME,
                        isFadingOut: false
                    });
                    
                    state.activeEmojis.push({
                        x: rightX * scaleX,
                        y: rightY * scaleY,
                        emoji: emoji,
                        size: emojiSize * (0.9 + Math.random() * 0.2),
                        rotation: Math.random() * 0.2 - 0.1,
                        opacity: 1,
                        life: 1.0,
                        decay: 0.01,
                        createdAt: Date.now(),
                        maxLifetime: CONFIG.EMOJI_LIFETIME,
                        isFadingOut: false
                    });
                    
                    // –ü–ª–∞–≤–∞—é—á—ñ –µ–º–æ–¥–∂—ñ
                    this.createFloatingEmoji(leftX * scaleX, leftY * scaleY, emoji);
                    this.createFloatingEmoji(rightX * scaleX, rightY * scaleY, emoji);
                    
                    state.stats.totalKisses += 2;
                    this.playKissSound();
                    this.createConfetti(leftX * scaleX, leftY * scaleY);
                    this.createConfetti(rightX * scaleX, rightY * scaleY);
                }
                
                createFloatingEmoji(x, y, emoji) {
                    const floatingEmoji = document.createElement('div');
                    floatingEmoji.className = 'emoji-float';
                    floatingEmoji.textContent = emoji;
                    floatingEmoji.style.left = `${x}px`;
                    floatingEmoji.style.top = `${y}px`;
                    floatingEmoji.style.color = emoji === 'üíã' ? '#ff4757' : '#ff6b6b';
                    
                    document.body.appendChild(floatingEmoji);
                    
                    setTimeout(() => {
                        if (floatingEmoji.parentNode) {
                            floatingEmoji.parentNode.removeChild(floatingEmoji);
                        }
                    }, CONFIG.EMOJI_DURATION);
                }
                
                updateEmojis() {
                    const now = Date.now();
                    
                    // –û—á–∏—â–µ–Ω–Ω—è canvas
                    ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                    
                    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –µ–º–æ–¥–∂—ñ
                    for (let i = state.activeEmojis.length - 1; i >= 0; i--) {
                        const emoji = state.activeEmojis[i];
                        
                        const age = now - emoji.createdAt;
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–Ω–∏–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏
                        if (age > emoji.maxLifetime && !emoji.isFadingOut) {
                            emoji.isFadingOut = true;
                            emoji.fadeOutStart = now;
                            emoji.decay = 0.002;
                        }
                        
                        // –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–µ –∑–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø—ñ—Å–ª—è –ø–æ—á–∞—Ç–∫—É fade out
                        if (emoji.isFadingOut && now - emoji.fadeOutStart > CONFIG.EMOJI_FADE_OUT_TIME) {
                            emoji.decay = 0.1;
                        }
                        
                        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∂–∏—Ç—Ç—è
                        emoji.life -= emoji.decay;
                        emoji.opacity = Math.max(0, emoji.life);
                        
                        // –í–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–Ω–∏–∫–ª–∏—Ö –µ–º–æ–¥–∂—ñ
                        if (emoji.opacity <= 0.1) {
                            state.activeEmojis.splice(i, 1);
                            continue;
                        }
                        
                        this.drawEmoji(emoji);
                    }
                    
                    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–Ω—Ñ–µ—Ç—ñ
                    this.updateConfetti();
                }
                
                drawEmoji(emoji) {
                    ctx.save();
                    ctx.translate(emoji.x, emoji.y);
                    ctx.rotate(emoji.rotation);
                    ctx.globalAlpha = emoji.opacity;
                    
                    // –¢—ñ–Ω—å
                    ctx.shadowColor = emoji.emoji === 'üíã' ? 'rgba(255, 71, 87, 0.9)' : 'rgba(255, 107, 107, 0.9)';
                    ctx.shadowBlur = 25 * emoji.opacity;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                    
                    // –ú–∞–ª—é–≤–∞–Ω–Ω—è –µ–º–æ–¥–∂—ñ
                    ctx.font = `bold ${emoji.size}px Arial, "Apple Color Emoji", "Segoe UI Emoji", sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = emoji.emoji === 'üíã' ? '#ff4757' : '#ff6b6b';
                    ctx.fillText(emoji.emoji, 0, 0);
                    
                    ctx.restore();
                }
                
                // ========== –ö–û–ù–§–ï–¢–Ü ==========
                createConfetti(x, y) {
                    const particleCount = state.isLandscape ? 6 : 8;
                    
                    for (let i = 0; i < particleCount; i++) {
                        state.confetti.push({
                            x: x, y: y,
                            vx: (Math.random() - 0.5) * 6,
                            vy: Math.random() * -12 - 3,
                            size: Math.random() * 5 + 2,
                            color: Math.random() > 0.5 ? '#ff4757' : '#ff6b6b',
                            life: 1.0, gravity: 0.2,
                            rotation: Math.random() * Math.PI * 2,
                            spin: (Math.random() - 0.5) * 0.15
                        });
                    }
                }
                
                updateConfetti() {
                    for (let i = state.confetti.length - 1; i >= 0; i--) {
                        const particle = state.confetti[i];
                        
                        particle.vy += particle.gravity;
                        particle.x += particle.vx;
                        particle.y += particle.vy;
                        particle.life -= 0.015;
                        particle.rotation += particle.spin;
                        
                        if (particle.life <= 0) {
                            state.confetti.splice(i, 1);
                            continue;
                        }
                        
                        ctx.save();
                        ctx.globalAlpha = particle.life;
                        ctx.translate(particle.x, particle.y);
                        ctx.rotate(particle.rotation);
                        ctx.fillStyle = particle.color;
                        ctx.fillRect(-particle.size/2, -particle.size/2, particle.size, particle.size);
                        ctx.restore();
                    }
                }
                
                playKissSound() {
                    if (!state.isSoundOn) return;
                    
                    try {
                        elements.kissSound.currentTime = 0;
                        elements.kissSound.volume = 0.7;
                        elements.kissSound.play().catch(e => console.log('–ó–≤—É–∫ –ø–æ—Ü—ñ–ª—É–Ω–∫—É:', e));
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–≤—É–∫—É:', error);
                    }
                }
                
                // ========== –Ü–ù–¢–ï–†–§–ï–ô–° ==========
                showSmileIndicator(percent) {
                    let smileText;
                    if (percent > 70) smileText = '–í–ê–£! üíãüíã';
                    else if (percent > 50) smileText = '–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! üòò';
                    else if (percent > 30) smileText = '–í—ñ—Ç–∞—î–º–æ.–ë–æ—Ö–æ–Ω–∫–∏! üòä';
                    else smileText = '–ó–¥—ñ–π—Å–Ω–µ–Ω–Ω—è –±–∞–∂–∞–Ω—å!';
                    
                    document.getElementById('smileText').textContent = smileText;
                    elements.smileIndicator.style.display = 'flex';
                }
                
                hideSmileIndicator() {
                    elements.smileIndicator.style.display = 'none';
                }
                
                hideLoading() {
                    elements.loading.style.display = 'none';
                    elements.startButton.style.display = 'none';
                    elements.title.style.display = 'block';
                    state.isRunning = true;
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è –º—É–∑–∏–∫–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
                    setTimeout(() => {
                        if (!state.isSoundOn) {
                            showMessage('üéµ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É üîä —â–æ–± —É–≤—ñ–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É!', 5000);
                        }
                    }, 2000);
                }
                
                // ========== CANVAS –¢–ê –û–†–Ü–Ñ–ù–¢–ê–¶–Ü–Ø ==========
                setupCanvas() {
                    this.resizeCanvas();
                    
                    window.addEventListener('resize', () => {
                        this.resizeCanvas();
                        state.isLandscape = window.innerWidth > window.innerHeight;
                    });
                    
                    window.addEventListener('orientationchange', () => {
                        setTimeout(() => {
                            this.resizeCanvas();
                            state.isLandscape = window.innerWidth > window.innerHeight;
                        }, 300);
                    });
                }
                
                resizeCanvas() {
                    const width = window.innerWidth;
                    const height = window.innerHeight;
                    
                    elements.canvas.width = width * window.devicePixelRatio || 1;
                    elements.canvas.height = height * window.devicePixelRatio || 1;
                    
                    // –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –¥–ª—è retina –¥–∏—Å–ø–ª–µ—ó–≤
                    if (window.devicePixelRatio > 1) {
                        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                    }
                    
                    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤
                    elements.canvas.style.width = width + 'px';
                    elements.canvas.style.height = height + 'px';
                }
                
                setupOrientation() {
                    // –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–º—É –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—é –Ω–∞ iOS
                    document.addEventListener('touchstart', function(e) {
                        if (e.touches.length > 1) {
                            e.preventDefault();
                        }
                    }, { passive: false });
                    
                    // –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∑—É–º—É –Ω–∞ iOS
                    document.addEventListener('gesturestart', function(e) {
                        e.preventDefault();
                    });
                }
                
                // ========== –ì–õ–ê–í–ù–ò–ô –¶–ò–ö–õ ==========
                startRenderLoop() {
                    const render = (currentTime) => {
                        if (currentTime - state.lastRenderTime >= 1000 / CONFIG.TARGET_FPS) {
                            if (state.isRunning) {
                                this.detectFace();
                                this.updateEmojis();
                            }
                            state.lastRenderTime = currentTime;
                        }
                        state.animationFrameId = requestAnimationFrame(render);
                    };
                    render(performance.now());
                }
                
                // ========== –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô ==========
                setupEventListeners() {
                    elements.startButton.addEventListener('click', () => this.hideLoading());
                    elements.startButton.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.hideLoading();
                    });
                    
                    elements.soundBtn.addEventListener('click', () => toggleSound());
                    elements.soundBtn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        toggleSound();
                    });
                    
                    elements.cameraBtn.addEventListener('click', () => this.switchCamera());
                    elements.cameraBtn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.switchCamera();
                    });
                    
                    // –î–µ–±–∞–≥ —Ä–µ–∂–∏–º
                    document.addEventListener('keypress', (e) => {
                        if (e.key === 'd' || e.key === 'D') {
                            state.showDebug = !state.showDebug;
                            elements.debugPanel.style.display = state.showDebug ? 'block' : 'none';
                        }
                    });
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è –∞—É–¥—ñ–æ –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –≤–∑–∞—î–º–æ–¥—ñ—ó
                    document.addEventListener('click', unlockAudio, { once: true });
                    document.addEventListener('touchstart', unlockAudio, { once: true });
                    
                    // –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–º—É –º–µ–Ω—é –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö
                    document.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                    });
                }
                
                // ========== –ü–û–ú–ò–õ–ö–ò ==========
                showCompatibilityError(issues) {
                    elements.loading.innerHTML = `
                        <div style="color: #ff4757; font-size: clamp(20px, 5vw, 24px); margin-bottom: 15px; text-align: center;">
                            –ü—Ä–æ–±–ª–µ–º–∞ –∑ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—é
                        </div>
                        <div style="color: white; font-size: clamp(14px, 3vw, 16px); margin-bottom: 20px; line-height: 1.4; text-align: center; max-width: min(90vw, 300px);">
                            ${issues.join('<br>')}
                        </div>
                        <button onclick="location.reload()" style="
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #ff6b6b, #ff4757);
                            border: none;
                            color: white;
                            font-size: clamp(14px, 3vw, 16px);
                            font-weight: bold;
                            cursor: pointer;
                            border-radius: 25px;
                            transition: all 0.3s ease;
                        ">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
                    `;
                }
                
                handleError(error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞—Ç–∫—É:', error);
                    
                    let message = '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞';
                    let details = '';
                    
                    if (error.message === 'CAMERA_ERROR') {
                        message = '–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏';
                        details = '–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
                    } else if (error.message.includes('Face Mesh')) {
                        message = '–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –æ–±–ª–∏—á';
                        details = '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
                    }
                    
                    elements.loading.innerHTML = `
                        <div style="color: #ff4757; font-size: clamp(20px, 5vw, 24px); margin-bottom: 15px; text-align: center;">${message}</div>
                        <div style="color: white; font-size: clamp(14px, 3vw, 16px); margin-bottom: 20px; line-height: 1.4; text-align: center; max-width: min(90vw, 300px);">${details}</div>
                        <button onclick="location.reload()" style="
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #ff6b6b, #ff4757);
                            border: none;
                            color: white;
                            font-size: clamp(14px, 3vw, 16px);
                            font-weight: bold;
                            cursor: pointer;
                            border-radius: 25px;
                            transition: all 0.3s ease;
                        ">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
                    `;
                }
                
                cleanup() {
                    if (state.animationFrameId) cancelAnimationFrame(state.animationFrameId);
                    if (state.videoStream) state.videoStream.getTracks().forEach(track => track.stop());
                }
            }
            
            // –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É
            window.addEventListener('DOMContentLoaded', () => {
                // –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è bounce –Ω–∞ iOS
                document.body.addEventListener('touchmove', function(e) {
                    if (e.scale !== 1) { e.preventDefault(); }
                }, { passive: false });
                
                new KissARApp();
            });
            
        })();
    </script>
</body>
</html>
