<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>üéÇ –ó –î–Ω–µ–º –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –í–∞–¥—ñ–∫! üíã –ü–æ—Ü—ñ–ª—É–Ω–∫–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #000;
            color: white;
        }
        
        /* –í—ñ–¥–µ–æ —Ñ–æ–Ω */
        #video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            transform: scaleX(-1); /* –î–∑–µ—Ä–∫–∞–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è */
            z-index: 1;
        }
        
        /* Canvas –¥–ª—è –µ–º–æ–¥–∂—ñ */
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        /* –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #startButton {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            font-size: 24px;
            background: linear-gradient(135deg, #ff6b6b, #ff4757);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }
        
        #title {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: clamp(24px, 5vw, 36px);
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            white-space: nowrap;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            gap: 25px;
        }
        
        .loader {
            width: 70px;
            height: 70px;
            border: 4px solid rgba(255, 107, 107, 0.3);
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        #smileIndicator {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .smile-icon {
            font-size: 24px;
            animation: bounce 1s infinite;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è */
        .control-btn {
            position: fixed;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:hover { transform: scale(1.1); background: rgba(255, 255, 255, 0.25); }
        
        #soundBtn { top: 20px; left: 20px; }
        #cameraBtn { bottom: 20px; left: 20px; }
        
        /* –ö–æ–Ω—Ñ–µ—Ç—ñ */
        .confetti {
            position: fixed;
            width: 15px;
            height: 15px;
            background: #ff6b6b;
            border-radius: 50%;
            pointer-events: none;
            z-index: 3;
            animation: confetti-fall 3s linear forwards;
        }
        
        /* –ï–º–æ–¥–∂—ñ –∞–Ω—ñ–º–∞—Ü—ñ—è */
        .emoji-float {
            position: fixed;
            font-size: 60px;
            pointer-events: none;
            z-index: 3;
            animation: emoji-float 2s ease-out forwards;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.7);
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        @keyframes emoji-float {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-30px) scale(1.2); opacity: 1; }
            80% { transform: translateY(-100px) scale(1); opacity: 1; }
            100% { transform: translateY(-150px) scale(0.8); opacity: 0; }
        }
        
        @keyframes emoji-pop {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes heart-beat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            #startButton { padding: 18px 35px; font-size: 22px; }
            #title { top: 5%; font-size: 22px; padding: 12px 20px; }
            #smileIndicator { bottom: 80px; font-size: 16px; padding: 10px 20px; }
            .control-btn { width: 45px; height: 45px; font-size: 18px; }
            .emoji-float { font-size: 50px; }
        }
    </style>
</head>
<body>
    <!-- –í—ñ–¥–µ–æ –ø–æ—Ç–æ–∫ -->
    <video id="video" playsinline muted></video>
    
    <!-- Canvas –¥–ª—è –µ–º–æ–¥–∂—ñ -->
    <canvas id="canvas"></canvas>
    
    <!-- –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="title">üéÇ –ó –î–Ω–µ–º –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –í–∞–¥—ñ–∫! üíã</div>
    <button id="startButton">üé¨ –ü–æ—á–∞—Ç–∏ –≤–µ—Å–µ–ª–æ—â—ñ!</button>
    <div id="smileIndicator">
        <span class="smile-icon">üòä</span>
        <span id="smileText">–ü–æ—Å–º—ñ—Ö–Ω—ñ—Ç—å—Å—è –¥–ª—è –ø–æ—Ü—ñ–ª—É–Ω–∫—ñ–≤!</span>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
    <button id="soundBtn" class="control-btn" title="–£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫">üîä</button>
    <button id="cameraBtn" class="control-btn" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É">üì∑</button>
    
    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div id="loading">
        <div class="loader"></div>
        <div id="loadingText" style="font-size: 20px; text-align: center;">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –æ–±–ª–∏—á<br>
            <span style="font-size: 16px; opacity: 0.8;">–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏</span>
        </div>
    </div>

    <!-- –ê—É–¥—ñ–æ -->
    <audio id="backgroundMusic" loop>
        <source src="fon.mp3" type="audio/mpeg">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∞—É–¥—ñ–æ.
    </audio>
    <audio id="kissSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-kiss-2016.mp3" type="audio/mpeg">
    </audio>

    <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
    
    <script>
        (function() {
            'use strict';
            
            // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
            const CONFIG = {
                SMILE_THRESHOLD: 0.15, // –ü–æ—Ä—ñ–≥ –ø–æ—Å–º—ñ—à–∫–∏
                KISS_COOLDOWN: 800,    // –Ü–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ –ø–æ—Ü—ñ–ª—É–Ω–∫–∞–º–∏
                EMOJI_SIZE: 70,        // –†–æ–∑–º—ñ—Ä –µ–º–æ–¥–∂—ñ
                EMOJI_DURATION: 2000,  // –ß–∞—Å –∂–∏—Ç—Ç—è –µ–º–æ–¥–∂—ñ (–º—Å)
                SMOOTHING_FACTOR: 0.7, // –ó–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è
                TARGET_FPS: 30
            };
            
            // –ö–ª—é—á–æ–≤—ñ —Ç–æ—á–∫–∏ –æ–±–ª–∏—á—á—è
            const FACE_LANDMARKS = {
                LEFT_MOUTH: 61,
                RIGHT_MOUTH: 291,
                UPPER_LIP: 13,
                LOWER_LIP: 14,
                LEFT_CHEEK: 123,
                RIGHT_CHEEK: 352
            };
            
            // –†—ñ–∑–Ω—ñ –µ–º–æ–¥–∂—ñ –¥–ª—è –ø–æ—Ü—ñ–ª—É–Ω–∫—ñ–≤
            const KISS_EMOJIS = ['üíã', 'üòò', '‚ù§Ô∏è', 'ü•∞', 'üòö', 'ü§ó', 'üíñ', 'üíï'];
            
            // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
            const elements = {
                video: document.getElementById('video'),
                canvas: document.getElementById('canvas'),
                startButton: document.getElementById('startButton'),
                title: document.getElementById('title'),
                smileIndicator: document.getElementById('smileIndicator'),
                loading: document.getElementById('loading'),
                loadingText: document.getElementById('loadingText'),
                soundBtn: document.getElementById('soundBtn'),
                cameraBtn: document.getElementById('cameraBtn'),
                backgroundMusic: document.getElementById('backgroundMusic'),
                kissSound: document.getElementById('kissSound')
            };
            
            // Canvas –∫–æ–Ω—Ç–µ–∫—Å—Ç
            const ctx = elements.canvas.getContext('2d');
            
            // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
            const state = {
                isRunning: false,
                isFrontCamera: true,
                isSoundOn: true,
                faceMesh: null,
                videoStream: null,
                animationFrameId: null,
                lastSmileTime: 0,
                lastRenderTime: 0,
                smileLevel: 0,
                lastSmileLevel: 0,
                // –ê–∫—Ç–∏–≤–Ω—ñ –µ–º–æ–¥–∂—ñ –Ω–∞ —â–æ–∫–∞—Ö
                activeEmojis: [],
                // –ï–º–æ–¥–∂—ñ, —â–æ —Å–ø–ª–∏–≤–∞—é—Ç—å
                floatingEmojis: [],
                // –ö–æ–Ω—Ñ–µ—Ç—ñ
                confetti: [],
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                stats: {
                    totalKisses: 0,
                    maxSmileLevel: 0
                },
                lastResults: null
            };
            
            // ========== –û–°–ù–û–í–ù–ò–ô –ö–õ–ê–° ==========
            class KissARApp {
                constructor() {
                    this.init();
                }
                
                async init() {
                    try {
                        this.setupEventListeners();
                        await this.setupCamera();
                        await this.initFaceMesh();
                        this.setupCanvas();
                        this.hideLoading();
                        this.startRenderLoop();
                    } catch (error) {
                        this.handleError(error);
                    }
                }
                
                // ========== –ö–ê–ú–ï–†–ê ==========
                async setupCamera() {
                    try {
                        const constraints = {
                            video: {
                                facingMode: 'user',
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            }
                        };
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        elements.video.srcObject = stream;
                        state.videoStream = stream;
                        
                        await new Promise((resolve) => {
                            elements.video.onloadedmetadata = () => {
                                elements.video.play();
                                resolve();
                            };
                        });
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:', error);
                        throw new Error('CAMERA_ERROR');
                    }
                }
                
                async switchCamera() {
                    if (!state.videoStream) return;
                    
                    state.videoStream.getTracks().forEach(track => track.stop());
                    state.isFrontCamera = !state.isFrontCamera;
                    
                    try {
                        const constraints = {
                            video: {
                                facingMode: state.isFrontCamera ? 'user' : 'environment',
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            }
                        };
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        elements.video.srcObject = stream;
                        state.videoStream = stream;
                        
                        elements.video.style.transform = state.isFrontCamera ? 'scaleX(-1)' : 'scaleX(1)';
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏:', error);
                        state.isFrontCamera = !state.isFrontCamera;
                    }
                }
                
                // ========== FACE MESH ==========
                async initFaceMesh() {
                    try {
                        state.faceMesh = new FaceMesh({
                            locateFile: (file) => {
                                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                            }
                        });
                        
                        state.faceMesh.setOptions({
                            maxNumFaces: 1,
                            refineLandmarks: true,
                            minDetectionConfidence: 0.5,
                            minTrackingConfidence: 0.5
                        });
                        
                        state.faceMesh.onResults((results) => {
                            state.lastResults = results;
                        });
                        
                        const camera = new Camera(elements.video, {
                            onFrame: async () => {
                                if (state.faceMesh) {
                                    await state.faceMesh.send({image: elements.video});
                                }
                            },
                            width: 1280,
                            height: 720
                        });
                        
                        await camera.start();
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ Face Mesh:', error);
                        throw error;
                    }
                }
                
                detectFace() {
                    if (!state.lastResults || !state.isRunning) return;
                    
                    const results = state.lastResults;
                    
                    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                        const landmarks = results.multiFaceLandmarks[0];
                        this.analyzeSmile(landmarks);
                    } else {
                        this.hideSmileIndicator();
                    }
                }
                
                analyzeSmile(landmarks) {
                    if (!landmarks || landmarks.length < 400) return;
                    
                    const leftMouth = landmarks[FACE_LANDMARKS.LEFT_MOUTH];
                    const rightMouth = landmarks[FACE_LANDMARKS.RIGHT_MOUTH];
                    const upperLip = landmarks[FACE_LANDMARKS.UPPER_LIP];
                    const lowerLip = landmarks[FACE_LANDMARKS.LOWER_LIP];
                    
                    if (!leftMouth || !rightMouth || !upperLip || !lowerLip) return;
                    
                    const mouthWidth = Math.abs(rightMouth.x - leftMouth.x);
                    const mouthHeight = Math.abs(lowerLip.y - upperLip.y);
                    const ratio = mouthHeight / mouthWidth;
                    let smileScore = Math.max(0, 1 - (ratio * 3));
                    
                    state.smileLevel = state.lastSmileLevel * (1 - CONFIG.SMOOTHING_FACTOR) + 
                                      smileScore * CONFIG.SMOOTHING_FACTOR;
                    state.lastSmileLevel = state.smileLevel;
                    
                    const smilePercent = Math.round(state.smileLevel * 100);
                    
                    if (state.smileLevel > CONFIG.SMILE_THRESHOLD) {
                        this.showSmileIndicator(smilePercent);
                        
                        const now = Date.now();
                        if (now - state.lastSmileTime > CONFIG.KISS_COOLDOWN) {
                            this.addEmojis(landmarks);
                            state.lastSmileTime = now;
                        }
                    } else {
                        this.hideSmileIndicator();
                    }
                    
                    if (state.smileLevel > state.stats.maxSmileLevel) {
                        state.stats.maxSmileLevel = state.smileLevel;
                    }
                }
                
                // ========== –ï–ú–û–î–ñ–Ü –ù–ê –©–û–ö–ê–• ==========
                addEmojis(landmarks) {
                    if (landmarks.length < 400) return;
                    
                    const leftCheek = landmarks[FACE_LANDMARKS.LEFT_CHEEK];
                    const rightCheek = landmarks[FACE_LANDMARKS.RIGHT_CHEEK];
                    
                    if (!leftCheek || !rightCheek) return;
                    
                    // –í–∏–ø–∞–¥–∫–æ–≤—ñ –µ–º–æ–¥–∂—ñ –¥–ª—è –∫–æ–∂–Ω–æ—ó —â–æ–∫–∏
                    const leftEmoji = KISS_EMOJIS[Math.floor(Math.random() * KISS_EMOJIS.length)];
                    const rightEmoji = KISS_EMOJIS[Math.floor(Math.random() * KISS_EMOJIS.length)];
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    const videoWidth = elements.video.videoWidth;
                    const videoHeight = elements.video.videoHeight;
                    const canvasWidth = elements.canvas.width;
                    const canvasHeight = elements.canvas.height;
                    
                    const leftX = (state.isFrontCamera ? (1 - leftCheek.x) : leftCheek.x) * videoWidth;
                    const leftY = leftCheek.y * videoHeight;
                    const rightX = (state.isFrontCamera ? (1 - rightCheek.x) : rightCheek.x) * videoWidth;
                    const rightY = rightCheek.y * videoHeight;
                    
                    const scaleX = canvasWidth / videoWidth;
                    const scaleY = canvasHeight / videoHeight;
                    
                    // –î–æ–¥–∞—î–º–æ –µ–º–æ–¥–∂—ñ –Ω–∞ —â–æ–∫–∏
                    state.activeEmojis.push({
                        x: leftX * scaleX,
                        y: leftY * scaleY,
                        emoji: leftEmoji,
                        size: CONFIG.EMOJI_SIZE * (0.8 + Math.random() * 0.4),
                        rotation: Math.random() * 0.3 - 0.15,
                        opacity: 1,
                        life: 1.0,
                        decay: 0.005,
                        createdAt: Date.now()
                    });
                    
                    state.activeEmojis.push({
                        x: rightX * scaleX,
                        y: rightY * scaleY,
                        emoji: rightEmoji,
                        size: CONFIG.EMOJI_SIZE * (0.8 + Math.random() * 0.4),
                        rotation: Math.random() * 0.3 - 0.15,
                        opacity: 1,
                        life: 1.0,
                        decay: 0.005,
                        createdAt: Date.now()
                    });
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ —Å–ø–ª–∏–≤–∞—é—á—ñ –µ–º–æ–¥–∂—ñ
                    this.createFloatingEmoji(leftX * scaleX, leftY * scaleY, leftEmoji);
                    this.createFloatingEmoji(rightX * scaleX, rightY * scaleY, rightEmoji);
                    
                    state.stats.totalKisses += 2;
                    
                    // –ó–≤—É–∫ –ø–æ—Ü—ñ–ª—É–Ω–∫—É
                    this.playKissSound();
                    
                    // –ö–æ–Ω—Ñ–µ—Ç—ñ
                    this.createConfetti(leftX * scaleX, leftY * scaleY);
                    this.createConfetti(rightX * scaleX, rightY * scaleY);
                }
                
                createFloatingEmoji(x, y, emoji) {
                    const floatingEmoji = document.createElement('div');
                    floatingEmoji.className = 'emoji-float';
                    floatingEmoji.textContent = emoji;
                    floatingEmoji.style.left = `${x}px`;
                    floatingEmoji.style.top = `${y}px`;
                    floatingEmoji.style.fontSize = `${CONFIG.EMOJI_SIZE}px`;
                    
                    // –í–∏–ø–∞–¥–∫–æ–≤–∏–π –∫–æ–ª—ñ—Ä
                    const colors = ['#ff6b6b', '#ff4757', '#ff8e53', '#ff6b8b'];
                    floatingEmoji.style.color = colors[Math.floor(Math.random() * colors.length)];
                    
                    document.body.appendChild(floatingEmoji);
                    
                    // –í–∏–¥–∞–ª—è—î–º–æ –ø—ñ—Å–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó
                    setTimeout(() => {
                        if (floatingEmoji.parentNode) {
                            floatingEmoji.parentNode.removeChild(floatingEmoji);
                        }
                    }, CONFIG.EMOJI_DURATION);
                }
                
                updateEmojis() {
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∞ –º–∞–ª—é—î–º–æ –µ–º–æ–¥–∂—ñ –Ω–∞ —â–æ–∫–∞—Ö
                    ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                    
                    for (let i = state.activeEmojis.length - 1; i >= 0; i--) {
                        const emoji = state.activeEmojis[i];
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –∂–∏—Ç—Ç—è
                        emoji.life -= emoji.decay;
                        emoji.opacity = emoji.life;
                        
                        if (emoji.life <= 0) {
                            state.activeEmojis.splice(i, 1);
                            continue;
                        }
                        
                        // –ú–∞–ª—é—î–º–æ –µ–º–æ–¥–∂—ñ
                        this.drawEmoji(emoji);
                    }
                }
                
                drawEmoji(emoji) {
                    ctx.save();
                    ctx.translate(emoji.x, emoji.y);
                    ctx.rotate(emoji.rotation);
                    ctx.globalAlpha = emoji.opacity;
                    
                    // –¢—ñ–Ω—å
                    ctx.shadowColor = 'rgba(255, 107, 107, 0.8)';
                    ctx.shadowBlur = 20;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                    
                    // –ï–º–æ–¥–∂—ñ
                    ctx.font = `bold ${emoji.size}px Arial, sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = this.getEmojiColor(emoji.emoji);
                    ctx.fillText(emoji.emoji, 0, 0);
                    
                    // –ê–Ω—ñ–º–∞—Ü—ñ—è –ø—É–ª—å—Å–∞—Ü—ñ—ó –¥–ª—è —Å–µ—Ä–¥–µ—á–æ–∫
                    if (emoji.emoji === '‚ù§Ô∏è' || emoji.emoji === 'üíñ' || emoji.emoji === 'üíï') {
                        const scale = 1 + 0.2 * Math.sin(Date.now() * 0.01);
                        ctx.scale(scale, scale);
                    }
                    
                    ctx.restore();
                }
                
                getEmojiColor(emoji) {
                    const colorMap = {
                        'üíã': '#ff4757', // –Ø—Å–∫—Ä–∞–≤–æ-—á–µ—Ä–≤–æ–Ω–∏–π
                        'üòò': '#ff6b6b', // –ß–µ—Ä–≤–æ–Ω–∏–π
                        '‚ù§Ô∏è': '#ff3838', // –ß–µ—Ä–≤–æ–Ω–∏–π
                        'ü•∞': '#ff8e53', // –ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π
                        'üòö': '#ff6b8b', // –†–æ–∂–µ–≤–∏–π
                        'ü§ó': '#4ecdc4', // –ë—ñ—Ä—é–∑–æ–≤–∏–π
                        'üíñ': '#ff6bc9', // –†–æ–∂–µ–≤–∏–π
                        'üíï': '#ff8bbd'  // –°–≤—ñ—Ç–ª–æ-—Ä–æ–∂–µ–≤–∏–π
                    };
                    return colorMap[emoji] || '#ff6b6b';
                }
                
                // ========== –ö–û–ù–§–ï–¢–Ü ==========
                createConfetti(x, y) {
                    for (let i = 0; i < 10; i++) {
                        state.confetti.push({
                            x: x,
                            y: y,
                            vx: (Math.random() - 0.5) * 8,
                            vy: Math.random() * -15 - 5,
                            size: Math.random() * 6 + 3,
                            color: `hsl(${Math.random() * 60}, 100%, 65%)`,
                            life: 1.0,
                            gravity: 0.3,
                            rotation: Math.random() * Math.PI * 2,
                            spin: (Math.random() - 0.5) * 0.2
                        });
                    }
                }
                
                updateConfetti() {
                    for (let i = state.confetti.length - 1; i >= 0; i--) {
                        const particle = state.confetti[i];
                        
                        particle.vy += particle.gravity;
                        particle.x += particle.vx;
                        particle.y += particle.vy;
                        particle.life -= 0.02;
                        particle.rotation += particle.spin;
                        
                        if (particle.life <= 0) {
                            state.confetti.splice(i, 1);
                            continue;
                        }
                        
                        ctx.save();
                        ctx.globalAlpha = particle.life;
                        ctx.translate(particle.x, particle.y);
                        ctx.rotate(particle.rotation);
                        ctx.fillStyle = particle.color;
                        ctx.fillRect(-particle.size/2, -particle.size/2, particle.size, particle.size);
                        ctx.restore();
                    }
                }
                
                // ========== –ê–£–î–Ü–û ==========
                playKissSound() {
                    if (!state.isSoundOn) return;
                    
                    try {
                        elements.kissSound.currentTime = 0;
                        elements.kissSound.play().catch(e => console.log('–ó–≤—É–∫ –ø–æ—Ü—ñ–ª—É–Ω–∫—É:', e));
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–≤—É–∫—É:', error);
                    }
                }
                
                toggleSound() {
                    state.isSoundOn = !state.isSoundOn;
                    
                    if (state.isSoundOn) {
                        elements.backgroundMusic.play().catch(e => {
                            console.log('–§–æ–Ω–æ–≤–∞ –º—É–∑–∏–∫–∞:', e);
                        });
                        elements.soundBtn.textContent = 'üîä';
                    } else {
                        elements.backgroundMusic.pause();
                        elements.soundBtn.textContent = 'üîá';
                    }
                }
                
                // ========== –Ü–ù–¢–ï–†–§–ï–ô–° ==========
                showSmileIndicator(percent) {
                    let smileText;
                    if (percent > 70) smileText = '–í–ê–£! –ß—É–¥–æ–≤–∞ –ø–æ—Å–º—ñ—à–∫–∞! üíãüíã';
                    else if (percent > 50) smileText = '–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –¢—Ä–∏–º–∞–π—Ç–µ –ø–æ—Å–º—ñ—à–∫—É! üòò';
                    else if (percent > 30) smileText = '–î–æ–±—Ä–µ! –ü–æ—Å–º—ñ—Ö–∞–π—Ç–µ—Å—è —à–∏—Ä—à–µ! üòä';
                    else smileText = '–ü–æ—Å–º—ñ—Ö–Ω—ñ—Ç—å—Å—è –¥–ª—è –ø–æ—Ü—ñ–ª—É–Ω–∫—ñ–≤!';
                    
                    document.getElementById('smileText').textContent = smileText;
                    elements.smileIndicator.style.display = 'flex';
                }
                
                hideSmileIndicator() {
                    elements.smileIndicator.style.display = 'none';
                }
                
                hideLoading() {
                    elements.loading.style.display = 'none';
                    elements.startButton.style.display = 'none';
                    elements.title.style.display = 'block';
                    state.isRunning = true;
                    
                    setTimeout(() => {
                        if (state.isSoundOn) {
                            this.toggleSound();
                        }
                    }, 500);
                }
                
                // ========== CANVAS ==========
                setupCanvas() {
                    elements.canvas.width = window.innerWidth;
                    elements.canvas.height = window.innerHeight;
                    
                    window.addEventListener('resize', () => {
                        elements.canvas.width = window.innerWidth;
                        elements.canvas.height = window.innerHeight;
                    });
                }
                
                // ========== –ì–õ–ê–í–ù–ò–ô –¶–ò–ö–õ ==========
                startRenderLoop() {
                    const render = (currentTime) => {
                        if (currentTime - state.lastRenderTime >= 1000 / CONFIG.TARGET_FPS) {
                            if (state.isRunning) {
                                this.detectFace();
                                this.updateEmojis();
                                this.updateConfetti();
                            }
                            state.lastRenderTime = currentTime;
                        }
                        state.animationFrameId = requestAnimationFrame(render);
                    };
                    render(performance.now());
                }
                
                // ========== –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô ==========
                setupEventListeners() {
                    elements.startButton.addEventListener('click', () => this.hideLoading());
                    elements.soundBtn.addEventListener('click', () => this.toggleSound());
                    elements.cameraBtn.addEventListener('click', () => this.switchCamera());
                    
                    document.addEventListener('click', () => {
                        if (!state.isRunning) this.hideLoading();
                        if (state.isSoundOn && elements.backgroundMusic.paused) {
                            elements.backgroundMusic.play().catch(() => {});
                        }
                    }, { once: true });
                }
                
                handleError(error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞—Ç–∫—É:', error);
                    
                    let message = '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞';
                    let details = '';
                    
                    if (error.message === 'CAMERA_ERROR') {
                        message = '–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏';
                        details = '–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
                    } else if (error.message.includes('Face Mesh')) {
                        message = '–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –æ–±–ª–∏—á';
                        details = '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
                    }
                    
                    elements.loading.innerHTML = `
                        <div style="color: #ff4757; font-size: 24px; margin-bottom: 15px;">${message}</div>
                        <div style="color: white; font-size: 16px; margin-bottom: 20px; line-height: 1.4;">${details}</div>
                        <button onclick="location.reload()" style="
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #ff6b6b, #ff4757);
                            border: none;
                            color: white;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                            border-radius: 25px;
                            transition: all 0.3s ease;
                        ">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
                    `;
                }
                
                cleanup() {
                    if (state.animationFrameId) cancelAnimationFrame(state.animationFrameId);
                    if (state.videoStream) state.videoStream.getTracks().forEach(track => track.stop());
                }
            }
            
            // –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É
            window.addEventListener('DOMContentLoaded', () => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    elements.loading.innerHTML = `
                        <div style="color: #ff4757; font-size: 24px; margin-bottom: 15px;">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î</div>
                        <div style="color: white; font-size: 16px; margin-bottom: 20px; line-height: 1.4;">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏.<br>
                            –°–ø—Ä–æ–±—É–π—Ç–µ Chrome, Edge –∞–±–æ Safari.
                        </div>
                    `;
                    return;
                }
                
                new KissARApp();
            });
            
        })();
    </script>
</body>
</html>
