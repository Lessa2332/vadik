<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>üéÇ –ó –î–Ω–µ–º –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è! </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            height: 100vh;
        }
        
        /* –í—ñ–¥–µ–æ —Ñ–æ–Ω */
        #video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            transform: scaleX(-1);
            z-index: 1;
        }
        
        /* Canvas –¥–ª—è –µ–º–æ–¥–∂—ñ */
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        /* –ì–æ–ª–æ–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞ */
        #startButton {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 25px 50px;
            font-size: 28px;
            background: linear-gradient(135deg, #ff6b6b, #ff4757);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
            box-shadow: 0 20px 50px rgba(255, 107, 107, 0.6),
                        0 0 0 4px rgba(255, 107, 107, 0.3),
                        0 0 0 8px rgba(255, 107, 107, 0.1);
            animation: pulse-glow 2s infinite, bounce 3s infinite;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        #startButton:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 25px 60px rgba(255, 107, 107, 0.8),
                        0 0 0 6px rgba(255, 107, 107, 0.4),
                        0 0 0 12px rgba(255, 107, 107, 0.2);
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∑–≤—É–∫—É - –Ø–°–ö–†–ê–í–ê –¢–ê –ü–£–õ–¨–°–£–Æ–ß–ê */
        #soundBtn {
            position: fixed;
            top: 25px;
            left: 25px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            border: 3px solid white;
            color: white;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 15px 35px rgba(78, 205, 196, 0.7),
                        0 0 0 3px rgba(255, 255, 255, 0.5);
            animation: sound-pulse 1.5s infinite;
            font-weight: bold;
        }
        
        #soundBtn:hover {
            transform: scale(1.15);
            box-shadow: 0 20px 45px rgba(78, 205, 196, 0.9),
                        0 0 0 4px rgba(255, 255, 255, 0.7);
        }
        
        #soundBtn.muted {
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.7),
                        0 0 0 3px rgba(255, 255, 255, 0.5);
        }
        
        #title {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: clamp(28px, 6vw, 42px);
            font-weight: bold;
            text-shadow: 0 4px 15px rgba(0,0,0,0.9);
            z-index: 10;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 183, 77, 0.9));
            padding: 20px 35px;
            border-radius: 25px;
            backdrop-filter: blur(15px);
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            white-space: nowrap;
            animation: title-float 4s infinite ease-in-out;
        }
        
        #smileIndicator {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 183, 77, 0.9));
            backdrop-filter: blur(15px);
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 10;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            animation: slide-up 0.5s ease;
        }
        
        .smile-icon {
            font-size: 32px;
            animation: bounce 1s infinite;
        }
        
        /* –î–µ–±–∞–≥-–ø–∞–Ω–µ–ª—å –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è */
        #debugPanel {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            display: block;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            gap: 30px;
        }
        
        .loader {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(255, 107, 107, 0.3);
            border-top: 5px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
        }
        
        /* –ï–º–æ–¥–∂—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó */
        .emoji-float {
            position: fixed;
            font-size: 70px;
            pointer-events: none;
            z-index: 3;
            animation: emoji-float 2s ease-out forwards;
            text-shadow: 0 0 30px rgba(255, 107, 107, 0.9);
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä–∏ */
        #cameraBtn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        #cameraBtn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
        @keyframes pulse-glow {
            0% { 
                box-shadow: 0 20px 50px rgba(255, 107, 107, 0.6),
                            0 0 0 4px rgba(255, 107, 107, 0.3),
                            0 0 0 8px rgba(255, 107, 107, 0.1);
            }
            50% { 
                box-shadow: 0 25px 60px rgba(255, 107, 107, 0.8),
                            0 0 0 6px rgba(255, 107, 107, 0.4),
                            0 0 0 12px rgba(255, 107, 107, 0.2);
            }
            100% { 
                box-shadow: 0 20px 50px rgba(255, 107, 107, 0.6),
                            0 0 0 4px rgba(255, 107, 107, 0.3),
                            0 0 0 8px rgba(255, 107, 107, 0.1);
            }
        }
        
        @keyframes sound-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 15px 35px rgba(78, 205, 196, 0.7),
                            0 0 0 3px rgba(255, 255, 255, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 20px 45px rgba(78, 205, 196, 0.9),
                            0 0 0 4px rgba(255, 255, 255, 0.7);
            }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes emoji-float {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-40px) scale(1.3); opacity: 1; }
            80% { transform: translateY(-120px) scale(1); opacity: 1; }
            100% { transform: translateY(-180px) scale(0.8); opacity: 0; }
        }
        
        @keyframes title-float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
        
        @keyframes slide-up {
            from { 
                opacity: 0;
                transform: translateX(-50%) translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è */
        #instruction {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 16px;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: none;
            z-index: 10;
            line-height: 1.5;
        }
        
        #instruction strong {
            color: #4ECDC4;
            display: block;
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        @media (max-width: 768px) {
            #startButton {
                padding: 22px 45px;
                font-size: 24px;
                width: 90%;
                text-align: center;
            }
            
            #soundBtn {
                width: 65px;
                height: 65px;
                font-size: 28px;
                top: 20px;
                left: 20px;
            }
            
            #title {
                font-size: 24px;
                padding: 18px 25px;
                top: 8%;
            }
            
            #smileIndicator {
                font-size: 18px;
                padding: 12px 25px;
                bottom: 100px;
            }
            
            .emoji-float {
                font-size: 60px;
            }
            
            #instruction {
                left: 20px;
                right: 20px;
                max-width: none;
            }
            
            #debugPanel {
                top: 80px;
                right: 10px;
                font-size: 10px;
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- –í—ñ–¥–µ–æ –ø–æ—Ç–æ–∫ -->
    <video id="video" playsinline muted></video>
    
    <!-- Canvas –¥–ª—è –µ–º–æ–¥–∂—ñ -->
    <canvas id="canvas"></canvas>
    
    <!-- –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="title">üéÇ –ó –î–Ω–µ–º –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –í–∞–¥—ñ–∫! üíã</div>
    <button id="startButton">üé¨ –ü–û–ß–ê–¢–ò!</button>
    <div id="smileIndicator">
        <span class="smile-icon">üòä</span>
        <span id="smileText">–ü–æ—Å–º—ñ—Ö–Ω–∏—Å—è!</span>
    </div>
    
    <!-- –î–µ–±–∞–≥-–ø–∞–Ω–µ–ª—å -->
    <div id="debugPanel" style="display: none;">
        <div>–°–º–∞–π–ª —Ä—ñ–≤–µ–Ω—å: <span id="debugSmile">0</span></div>
        <div>–ü–æ—Å–º—ñ—à–∫–∞: <span id="debugIsSmiling">–Ω—ñ</span></div>
        <div>–ï–º–æ–¥–∂—ñ: <span id="debugEmojiCount">0</span></div>
        <div>–í—ñ–¥–Ω–æ—à–µ–Ω–Ω—è: <span id="debugRatio">0</span></div>
    </div>
    
    <!-- –Ø–°–ö–†–ê–í–ê –∫–Ω–æ–ø–∫–∞ –∑–≤—É–∫—É -->
    <button id="soundBtn" class="control-btn" title="üéµ –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫">üîä</button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä–∏ -->
    <button id="cameraBtn" class="control-btn" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É">üì∑</button>
    
    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div id="loading">
        <div class="loader"></div>
        <div id="loadingText" style="font-size: 22px; text-align: center; max-width: 300px;">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –æ–±–ª–∏—á<br>
            <span style="font-size: 16px; opacity: 0.8; margin-top: 10px; display: block;">
                –ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
            </span>
        </div>
    </div>

    <!-- –ê–£–î–Ü–û -->
    <audio id="backgroundMusic" loop>
        <source src="fon.mp3" type="audio/mpeg">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∞—É–¥—ñ–æ.
    </audio>
    
    <!-- –†–µ–∑–µ—Ä–≤–Ω–µ –∞—É–¥—ñ–æ (—è–∫—â–æ fon.mp3 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ) -->
    <audio id="backupMusic" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-clear-sky-479.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="kissSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-kiss-2016.mp3" type="audio/mpeg">
    </audio>

    <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
    
    <script>
        (function() {
            'use strict';
            
            // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
            const CONFIG = {
                SMILE_THRESHOLD: 0.08,     // –ú–ï–ù–®–ò–ô –ø–æ—Ä—ñ–≥ –¥–ª—è –ø–æ—Å–º—ñ—à–∫–∏ (–∑–º—ñ–Ω–∏–≤ –∑ 0.18)
                KISS_COOLDOWN: 300,
                EMOJI_SIZE: 75,
                EMOJI_DURATION: 2000,
                EMOJI_LIFETIME: 1500,
                SMOOTHING_FACTOR: 0.7,
                TARGET_FPS: 30,
                ONLY_EMOJIS: ['üíã', 'üòò'],
                DEBUG: true  // –î–æ–¥–∞–Ω–æ –¥–µ–±–∞–≥ —Ä–µ–∂–∏–º
            };
            
            // –ö–ª—é—á–æ–≤—ñ —Ç–æ—á–∫–∏ –æ–±–ª–∏—á—á—è
            const FACE_LANDMARKS = {
                LEFT_MOUTH: 61,
                RIGHT_MOUTH: 291,
                UPPER_LIP: 13,
                LOWER_LIP: 14,
                LEFT_CHEEK: 123,
                RIGHT_CHEEK: 352
            };
            
            // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
            const elements = {
                video: document.getElementById('video'),
                canvas: document.getElementById('canvas'),
                startButton: document.getElementById('startButton'),
                title: document.getElementById('title'),
                smileIndicator: document.getElementById('smileIndicator'),
                loading: document.getElementById('loading'),
                loadingText: document.getElementById('loadingText'),
                soundBtn: document.getElementById('soundBtn'),
                cameraBtn: document.getElementById('cameraBtn'),
                instruction: document.getElementById('instruction'),
                backgroundMusic: document.getElementById('backgroundMusic'),
                backupMusic: document.getElementById('backupMusic'),
                kissSound: document.getElementById('kissSound'),
                debugPanel: document.getElementById('debugPanel'),
                debugSmile: document.getElementById('debugSmile'),
                debugIsSmiling: document.getElementById('debugIsSmiling'),
                debugEmojiCount: document.getElementById('debugEmojiCount'),
                debugRatio: document.getElementById('debugRatio')
            };
            
            // Canvas –∫–æ–Ω—Ç–µ–∫—Å—Ç
            const ctx = elements.canvas.getContext('2d');
            
            // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
            const state = {
                isRunning: false,
                isFrontCamera: true,
                isSoundOn: false,
                faceMesh: null,
                videoStream: null,
                animationFrameId: null,
                lastSmileTime: 0,
                lastRenderTime: 0,
                smileLevel: 0,
                lastSmileLevel: 0,
                activeEmojis: [],
                floatingEmojis: [],
                confetti: [],
                stats: { totalKisses: 0, maxSmileLevel: 0 },
                lastResults: null,
                audioContext: null,
                isAudioUnlocked: false,
                isSmiling: false,
                smileStartTime: 0,
                showDebug: CONFIG.DEBUG
            };
            
            // ========== –ê–£–î–Ü–û –°–ò–°–¢–ï–ú–ê ==========
            function unlockAudio() {
                if (state.isAudioUnlocked) return;
                
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (state.audioContext.state === 'suspended') {
                    state.audioContext.resume();
                }
                
                if (state.isSoundOn) {
                    playBackgroundMusic();
                }
                
                state.isAudioUnlocked = true;
                console.log('üîä –ê—É–¥—ñ–æ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ!');
            }
            
            function playBackgroundMusic() {
                if (!state.isSoundOn) return;
                
                elements.backgroundMusic.play().then(() => {
                    console.log('üéµ –ú—É–∑–∏–∫–∞ fon.mp3 –≥—Ä–∞—î');
                }).catch(error => {
                    console.log('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ fon.mp3:', error.message);
                    elements.backupMusic.play().then(() => {
                        console.log('üéµ –†–µ–∑–µ—Ä–≤–Ω–∞ –º—É–∑–∏–∫–∞ –≥—Ä–∞—î');
                        elements.soundBtn.innerHTML = 'üéµ';
                    }).catch(backupError => {
                        console.log('‚ùå –†–µ–∑–µ—Ä–≤–Ω–∞ –º—É–∑–∏–∫–∞ —Ç–µ–∂ –Ω–µ –ø—Ä–∞—Ü—é—î:', backupError.message);
                        elements.soundBtn.innerHTML = 'üîá';
                        state.isSoundOn = false;
                    });
                });
            }
            
            function toggleSound() {
                state.isSoundOn = !state.isSoundOn;
                
                if (!state.isAudioUnlocked) {
                    unlockAudio();
                }
                
                if (state.isSoundOn) {
                    elements.soundBtn.innerHTML = 'üîä';
                    elements.soundBtn.classList.remove('muted');
                    elements.soundBtn.title = 'üîä –ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ';
                    playBackgroundMusic();
                    showMessage('üéµ –ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ! –ù–∞—Å–æ–ª–æ–¥–∂—É–π—Ç–µ—Å—å –º—É–∑–∏–∫–æ—é!');
                } else {
                    elements.soundBtn.innerHTML = 'üîá';
                    elements.soundBtn.classList.add('muted');
                    elements.soundBtn.title = 'üîá –ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ';
                    elements.backgroundMusic.pause();
                    elements.backupMusic.pause();
                    showMessage('üîá –ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ');
                }
            }
            
            function showMessage(text) {
                const message = document.createElement('div');
                message.textContent = text;
                message.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    z-index: 1000;
                    font-weight: bold;
                    animation: fade-in-out 3s forwards;
                `;
                
                document.body.appendChild(message);
                
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 3000);
            }
            
            function updateDebugInfo() {
                if (!state.showDebug) return;
                
                elements.debugSmile.textContent = state.smileLevel.toFixed(3);
                elements.debugIsSmiling.textContent = state.isSmiling ? '–¢–ê–ö' : '–Ω—ñ';
                elements.debugEmojiCount.textContent = state.activeEmojis.length;
                elements.debugPanel.style.display = 'block';
            }
            
            // ========== –û–°–ù–û–í–ù–ò–ô –ö–õ–ê–° ==========
            class KissARApp {
                constructor() {
                    this.init();
                }
                
                async init() {
                    try {
                        this.setupEventListeners();
                        await this.setupCamera();
                        await this.initFaceMesh();
                        this.setupCanvas();
                        this.hideLoading();
                        this.startRenderLoop();
                        
                        setTimeout(() => {
                            elements.instruction.style.display = 'block';
                        }, 2000);
                        
                    } catch (error) {
                        this.handleError(error);
                    }
                }
                
                // ========== –ö–ê–ú–ï–†–ê ==========
                async setupCamera() {
                    try {
                        const constraints = {
                            video: {
                                facingMode: 'user',
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            }
                        };
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        elements.video.srcObject = stream;
                        state.videoStream = stream;
                        
                        await new Promise((resolve) => {
                            elements.video.onloadedmetadata = () => {
                                elements.video.play();
                                resolve();
                            };
                        });
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:', error);
                        throw new Error('CAMERA_ERROR');
                    }
                }
                
                async switchCamera() {
                    if (!state.videoStream) return;
                    
                    state.videoStream.getTracks().forEach(track => track.stop());
                    state.isFrontCamera = !state.isFrontCamera;
                    
                    try {
                        const constraints = {
                            video: {
                                facingMode: state.isFrontCamera ? 'user' : 'environment',
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            }
                        };
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        elements.video.srcObject = stream;
                        state.videoStream = stream;
                        
                        elements.video.style.transform = state.isFrontCamera ? 'scaleX(-1)' : 'scaleX(1)';
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏:', error);
                        state.isFrontCamera = !state.isFrontCamera;
                    }
                }
                
                // ========== FACE MESH ==========
                async initFaceMesh() {
                    try {
                        state.faceMesh = new FaceMesh({
                            locateFile: (file) => {
                                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                            }
                        });
                        
                        state.faceMesh.setOptions({
                            maxNumFaces: 1,
                            refineLandmarks: true,
                            minDetectionConfidence: 0.5,
                            minTrackingConfidence: 0.5
                        });
                        
                        state.faceMesh.onResults((results) => {
                            state.lastResults = results;
                        });
                        
                        const camera = new Camera(elements.video, {
                            onFrame: async () => {
                                if (state.faceMesh) {
                                    await state.faceMesh.send({image: elements.video});
                                }
                            },
                            width: 1280,
                            height: 720
                        });
                        
                        await camera.start();
                        
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ Face Mesh:', error);
                        throw error;
                    }
                }
                
                detectFace() {
                    if (!state.lastResults || !state.isRunning) return;
                    
                    const results = state.lastResults;
                    
                    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                        const landmarks = results.multiFaceLandmarks[0];
                        this.analyzeSmile(landmarks);
                    } else {
                        this.hideSmileIndicator();
                        state.isSmiling = false;
                    }
                    
                    updateDebugInfo();
                }
                
                analyzeSmile(landmarks) {
                    if (!landmarks || landmarks.length < 400) return;
                    
                    const leftMouth = landmarks[FACE_LANDMARKS.LEFT_MOUTH];
                    const rightMouth = landmarks[FACE_LANDMARKS.RIGHT_MOUTH];
                    const upperLip = landmarks[FACE_LANDMARKS.UPPER_LIP];
                    const lowerLip = landmarks[FACE_LANDMARKS.LOWER_LIP];
                    
                    if (!leftMouth || !rightMouth || !upperLip || !lowerLip) return;
                    
                    const mouthWidth = Math.abs(rightMouth.x - leftMouth.x);
                    const mouthHeight = Math.abs(lowerLip.y - upperLip.y);
                    
                    // –ö–û–†–ï–ö–¢–ù–ò–ô –†–û–ó–†–ê–•–£–ù–û–ö –ü–û–°–ú–Ü–®–ö–ò:
                    // –ö–æ–ª–∏ –ø–æ—Å–º—ñ—Ö–∞—î–º–æ—Å—è - —Ä–æ—Ç —Å—Ç–∞—î –®–ò–†–®–ò–ú —ñ –ú–ï–ù–® –í–ò–°–û–ö–ò–ú
                    // –¢–æ–º—É ratio = –≤–∏—Å–æ—Ç–∞ / —à–∏—Ä–∏–Ω–∞
                    const ratio = mouthHeight / mouthWidth;
                    
                    // –î–µ–±–∞–≥ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
                    if (state.showDebug) {
                        elements.debugRatio.textContent = ratio.toFixed(3);
                    }
                    
                    // –ö–æ—Ä–µ–∫—Ü—ñ—è —Ñ–æ—Ä–º—É–ª–∏: –º–µ–Ω—à–∏–π ratio = –±—ñ–ª—å—à–∞ –ø–æ—Å–º—ñ—à–∫–∞
                    // –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π —Ä–æ—Ç –º–∞—î ratio ~0.3-0.4
                    // –ü–æ—Å–º—ñ—à–∫–∞ –º–∞—î ratio < 0.2
                    let smileScore = Math.max(0, (0.4 - ratio) * 5); // –Ü–Ω–≤–µ—Ä—Ç—É—î–º–æ –ª–æ–≥—ñ–∫—É
                    
                    state.smileLevel = state.lastSmileLevel * (1 - CONFIG.SMOOTHING_FACTOR) + 
                                      smileScore * CONFIG.SMOOTHING_FACTOR;
                    state.lastSmileLevel = state.smileLevel;
                    
                    const smilePercent = Math.round(state.smileLevel * 100);
                    const now = Date.now();
                    
                    // –ù–û–í–ê –õ–û–ì–Ü–ö–ê: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ ratio –Ω–∞–ø—Ä—è–º—É
                    const wasSmiling = state.isSmiling;
                    
                    // Ratio –º–µ–Ω—à–µ = –ø–æ—Å–º—ñ—à–∫–∞ (—Ä–æ—Ç —à–∏—Ä—à–∏–π, –º–µ–Ω—à –≤–∏—Å–æ–∫–∏–π)
                    // –ü—Ä–∏ ratio < 0.25 - –ø–æ—Å–º—ñ—à–∫–∞
                    // –ü—Ä–∏ ratio < 0.15 - —à–∏—Ä–æ–∫–∞ –ø–æ—Å–º—ñ—à–∫–∞
                    const ratioThreshold = 0.25;
                    state.isSmiling = ratio < ratioThreshold;
                    
                    if (state.isSmiling) {
                        // –õ–Æ–î–ò–ù–ê –ü–û–°–ú–Ü–•–ê–Ñ–¢–¨–°–Ø
                        if (!wasSmiling) {
                            state.smileStartTime = now;
                        }
                        
                        this.showSmileIndicator(smilePercent);
                        
                        if (now - state.lastSmileTime > CONFIG.KISS_COOLDOWN) {
                            this.addEmojis(landmarks);
                            state.lastSmileTime = now;
                        }
                    } else {
                        // –õ–Æ–î–ò–ù–ê –ù–ï –ü–û–°–ú–Ü–•–ê–Ñ–¢–¨–°–Ø
                        this.hideSmileIndicator();
                        this.removeAllEmojisQuickly();
                    }
                }
                
                removeAllEmojisQuickly() {
                    const now = Date.now();
                    for (let i = state.activeEmojis.length - 1; i >= 0; i--) {
                        const emoji = state.activeEmojis[i];
                        emoji.life -= 0.15; // –î—É–∂–µ —à–≤–∏–¥–∫–æ –∑–Ω–∏–∫–∞—î
                        emoji.opacity = Math.max(0, emoji.life);
                        
                        if (emoji.opacity <= 0.1) {
                            state.activeEmojis.splice(i, 1);
                        }
                    }
                }
                
                // ========== –ï–ú–û–î–ñ–Ü –ù–ê –©–û–ö–ê–• ==========
                addEmojis(landmarks) {
                    if (landmarks.length < 400) return;
                    
                    const leftCheek = landmarks[FACE_LANDMARKS.LEFT_CHEEK];
                    const rightCheek = landmarks[FACE_LANDMARKS.RIGHT_CHEEK];
                    
                    if (!leftCheek || !rightCheek) return;
                    
                    const leftEmoji = CONFIG.ONLY_EMOJIS[Math.floor(Math.random() * CONFIG.ONLY_EMOJIS.length)];
                    const rightEmoji = CONFIG.ONLY_EMOJIS[Math.floor(Math.random() * CONFIG.ONLY_EMOJIS.length)];
                    
                    const videoWidth = elements.video.videoWidth;
                    const videoHeight = elements.video.videoHeight;
                    const canvasWidth = elements.canvas.width;
                    const canvasHeight = elements.canvas.height;
                    
                    const leftX = (state.isFrontCamera ? (1 - leftCheek.x) : leftCheek.x) * videoWidth;
                    const leftY = leftCheek.y * videoHeight;
                    const rightX = (state.isFrontCamera ? (1 - rightCheek.x) : rightCheek.x) * videoWidth;
                    const rightY = rightCheek.y * videoHeight;
                    
                    const scaleX = canvasWidth / videoWidth;
                    const scaleY = canvasHeight / videoHeight;
                    
                    // –û–±–º–µ–∂—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –µ–º–æ–¥–∂—ñ
                    if (state.activeEmojis.length > 6) {
                        state.activeEmojis.splice(0, 2);
                    }
                    
                    state.activeEmojis.push({
                        x: leftX * scaleX,
                        y: leftY * scaleY,
                        emoji: leftEmoji,
                        size: CONFIG.EMOJI_SIZE * (0.9 + Math.random() * 0.2),
                        rotation: Math.random() * 0.2 - 0.1,
                        opacity: 1,
                        life: 1.0,
                        decay: 0.03,
                        createdAt: Date.now(),
                        maxLifetime: CONFIG.EMOJI_LIFETIME
                    });
                    
                    state.activeEmojis.push({
                        x: rightX * scaleX,
                        y: rightY * scaleY,
                        emoji: rightEmoji,
                        size: CONFIG.EMOJI_SIZE * (0.9 + Math.random() * 0.2),
                        rotation: Math.random() * 0.2 - 0.1,
                        opacity: 1,
                        life: 1.0,
                        decay: 0.03,
                        createdAt: Date.now(),
                        maxLifetime: CONFIG.EMOJI_LIFETIME
                    });
                    
                    // –°–ø–ª–∏–≤–∞—é—á—ñ –µ–º–æ–¥–∂—ñ
                    this.createFloatingEmoji(leftX * scaleX, leftY * scaleY, leftEmoji);
                    this.createFloatingEmoji(rightX * scaleX, rightY * scaleY, rightEmoji);
                    
                    state.stats.totalKisses += 2;
                    this.playKissSound();
                    this.createConfetti(leftX * scaleX, leftY * scaleY);
                    this.createConfetti(rightX * scaleX, rightY * scaleY);
                }
                
                createFloatingEmoji(x, y, emoji) {
                    const floatingEmoji = document.createElement('div');
                    floatingEmoji.className = 'emoji-float';
                    floatingEmoji.textContent = emoji;
                    floatingEmoji.style.left = `${x}px`;
                    floatingEmoji.style.top = `${y}px`;
                    floatingEmoji.style.fontSize = `${CONFIG.EMOJI_SIZE}px`;
                    floatingEmoji.style.color = emoji === 'üíã' ? '#ff4757' : '#ff6b6b';
                    
                    document.body.appendChild(floatingEmoji);
                    
                    setTimeout(() => {
                        if (floatingEmoji.parentNode) {
                            floatingEmoji.parentNode.removeChild(floatingEmoji);
                        }
                    }, CONFIG.EMOJI_DURATION);
                }
                
                updateEmojis() {
                    const now = Date.now();
                    
                    // –û—á–∏—â–∞—î–º–æ canvas
                    ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                    
                    // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ –µ–º–æ–¥–∂—ñ
                    for (let i = state.activeEmojis.length - 1; i >= 0; i--) {
                        const emoji = state.activeEmojis[i];
                        
                        const age = now - emoji.createdAt;
                        if (age > emoji.maxLifetime) {
                            state.activeEmojis.splice(i, 1);
                            continue;
                        }
                        
                        // –Ø–∫—â–æ –ª—é–¥–∏–Ω–∞ –Ω–µ –ø–æ—Å–º—ñ—Ö–∞—î—Ç—å—Å—è - –µ–º–æ–¥–∂—ñ –∑–Ω–∏–∫–∞—é—Ç—å —à–≤–∏–¥—à–µ
                        if (!state.isSmiling) {
                            emoji.decay = 0.15;
                        }
                        
                        emoji.life -= emoji.decay;
                        emoji.opacity = Math.max(0, emoji.life);
                        
                        if (emoji.opacity <= 0.1) {
                            state.activeEmojis.splice(i, 1);
                            continue;
                        }
                        
                        this.drawEmoji(emoji);
                    }
                }
                
                drawEmoji(emoji) {
                    ctx.save();
                    ctx.translate(emoji.x, emoji.y);
                    ctx.rotate(emoji.rotation);
                    ctx.globalAlpha = emoji.opacity;
                    
                    ctx.shadowColor = emoji.emoji === 'üíã' ? 'rgba(255, 71, 87, 0.9)' : 'rgba(255, 107, 107, 0.9)';
                    ctx.shadowBlur = 25 * emoji.opacity;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                    
                    ctx.font = `bold ${emoji.size}px Arial, sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = emoji.emoji === 'üíã' ? '#ff4757' : '#ff6b6b';
                    ctx.fillText(emoji.emoji, 0, 0);
                    
                    ctx.restore();
                }
                
                // ========== –ö–û–ù–§–ï–¢–Ü –¢–ê –ó–í–£–ö–ò ==========
                createConfetti(x, y) {
                    for (let i = 0; i < 8; i++) {
                        state.confetti.push({
                            x: x, y: y,
                            vx: (Math.random() - 0.5) * 6,
                            vy: Math.random() * -12 - 3,
                            size: Math.random() * 5 + 2,
                            color: Math.random() > 0.5 ? '#ff4757' : '#ff6b6b',
                            life: 1.0, gravity: 0.2,
                            rotation: Math.random() * Math.PI * 2,
                            spin: (Math.random() - 0.5) * 0.15
                        });
                    }
                }
                
                updateConfetti() {
                    for (let i = state.confetti.length - 1; i >= 0; i--) {
                        const particle = state.confetti[i];
                        
                        particle.vy += particle.gravity;
                        particle.x += particle.vx;
                        particle.y += particle.vy;
                        particle.life -= 0.015;
                        particle.rotation += particle.spin;
                        
                        if (particle.life <= 0) {
                            state.confetti.splice(i, 1);
                            continue;
                        }
                        
                        ctx.save();
                        ctx.globalAlpha = particle.life;
                        ctx.translate(particle.x, particle.y);
                        ctx.rotate(particle.rotation);
                        ctx.fillStyle = particle.color;
                        ctx.fillRect(-particle.size/2, -particle.size/2, particle.size, particle.size);
                        ctx.restore();
                    }
                }
                
                playKissSound() {
                    if (!state.isSoundOn) return;
                    
                    try {
                        elements.kissSound.currentTime = 0;
                        elements.kissSound.play().catch(e => console.log('–ó–≤—É–∫ –ø–æ—Ü—ñ–ª—É–Ω–∫—É:', e));
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–≤—É–∫—É:', error);
                    }
                }
                
                // ========== –Ü–ù–¢–ï–†–§–ï–ô–° ==========
                showSmileIndicator(percent) {
                    let smileText;
                    if (percent > 70) smileText = '–í–ê–£! üíãüíã';
                    else if (percent > 50) smileText = '–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ!  üòò';
                    else if (percent > 30) smileText = '–í—ñ—Ç–∞—î–º–æ.–ë–æ—Ö–æ–Ω–∫–∏! üòä';
                    else smileText = '–ó–¥—ñ–π—Å–Ω–µ–Ω–Ω—è –±–∞–∂–∞–Ω—å!';
                    
                    document.getElementById('smileText').textContent = smileText;
                    elements.smileIndicator.style.display = 'flex';
                }
                
                hideSmileIndicator() {
                    elements.smileIndicator.style.display = 'none';
                }
                
                hideLoading() {
                    elements.loading.style.display = 'none';
                    elements.startButton.style.display = 'none';
                    elements.title.style.display = 'block';
                    state.isRunning = true;
                    
                    elements.instruction.style.display = 'block';
                    
                    setTimeout(() => {
                        showMessage('üéµ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É üîä —â–æ–± —É–≤—ñ–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É!');
                    }, 1000);
                }
                
                // ========== CANVAS ==========
                setupCanvas() {
                    elements.canvas.width = window.innerWidth;
                    elements.canvas.height = window.innerHeight;
                    
                    window.addEventListener('resize', () => {
                        elements.canvas.width = window.innerWidth;
                        elements.canvas.height = window.innerHeight;
                    });
                }
                
                // ========== –ì–õ–ê–í–ù–ò–ô –¶–ò–ö–õ ==========
                startRenderLoop() {
                    const render = (currentTime) => {
                        if (currentTime - state.lastRenderTime >= 1000 / CONFIG.TARGET_FPS) {
                            if (state.isRunning) {
                                this.detectFace();
                                this.updateEmojis();
                                this.updateConfetti();
                            }
                            state.lastRenderTime = currentTime;
                        }
                        state.animationFrameId = requestAnimationFrame(render);
                    };
                    render(performance.now());
                }
                
                // ========== –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô ==========
                setupEventListeners() {
                    elements.startButton.addEventListener('click', () => this.hideLoading());
                    elements.soundBtn.addEventListener('click', () => toggleSound());
                    elements.cameraBtn.addEventListener('click', () => this.switchCamera());
                    
                    // –î–æ–¥–∞—î–º–æ —Ç–æ–≥–ª –¥–ª—è –¥–µ–±–∞–≥ –ø–∞–Ω–µ–ª—ñ
                    document.addEventListener('keypress', (e) => {
                        if (e.key === 'd' || e.key === 'D') {
                            state.showDebug = !state.showDebug;
                            elements.debugPanel.style.display = state.showDebug ? 'block' : 'none';
                        }
                    });
                    
                    document.addEventListener('click', () => {
                        if (!state.isRunning) {
                            this.hideLoading();
                        }
                        if (!state.isAudioUnlocked) {
                            unlockAudio();
                        }
                    }, { once: true });
                    
                    document.addEventListener('touchstart', unlockAudio, { once: true });
                    document.addEventListener('mousedown', unlockAudio, { once: true });
                }
                
                handleError(error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞—Ç–∫—É:', error);
                    
                    let message = '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞';
                    let details = '';
                    
                    if (error.message === 'CAMERA_ERROR') {
                        message = '–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏';
                        details = '–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ —É –Ω–∞–ª–∞—à—Ä—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
                    } else if (error.message.includes('Face Mesh')) {
                        message = '–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –æ–±–ª–∏—á';
                        details = '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
                    }
                    
                    elements.loading.innerHTML = `
                        <div style="color: #ff4757; font-size: 24px; margin-bottom: 15px;">${message}</div>
                        <div style="color: white; font-size: 16px; margin-bottom: 20px; line-height: 1.4;">${details}</div>
                        <button onclick="location.reload()" style="
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #ff6b6b, #ff4757);
                            border: none;
                            color: white;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                            border-radius: 25px;
                            transition: all 0.3s ease;
                        ">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
                    `;
                }
                
                cleanup() {
                    if (state.animationFrameId) cancelAnimationFrame(state.animationFrameId);
                    if (state.videoStream) state.videoStream.getTracks().forEach(track => track.stop());
                }
            }
            
            // –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É
            window.addEventListener('DOMContentLoaded', () => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    elements.loading.innerHTML = `
                        <div style="color: #ff4757; font-size: 24px; margin-bottom: 15px;">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î</div>
                        <div style="color: white; font-size: 16px; margin-bottom: 20px; line-height: 1.4;">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏.<br>
                            –°–ø—Ä–æ–±—É–π—Ç–µ Chrome, Edge –∞–±–æ Safari.
                        </div>
                    `;
                    return;
                }
                
                new KissARApp();
                
                // –î–æ–¥–∞—î–º–æ CSS –¥–ª—è fade-in-out –∞–Ω—ñ–º–∞—Ü—ñ—ó
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fade-in-out {
                        0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                        20% { opacity: 1; transform: translateX(-50%) translateY(0); }
                        80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    }
                `;
                document.head.appendChild(style);
            });
            
        })();
    </script>
</body>
</html>
